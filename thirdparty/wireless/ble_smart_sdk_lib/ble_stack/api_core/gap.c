
#include "at_ble_api.h"
#ifdef SAMB11
#include "platform_drv.h"
#include "interface.h"
#else
#include "platform.h"
#include "timer.h"
#endif	//SAMB11
#include "gattc_task.h"
#include "gattm_task.h"
#include "gapm_task.h"
#include "gapc_task.h"
#include "dbg_task.h"

#include "device.h"
#include "event.h"


// Slave preferred Connection interval Min
#define APP_CON_INTV_MIN	8
// Slave preferred Connection interval Max
#define APP_CON_INTV_MAX	10
// Slave preferred Connection latency
#define APP_CON_LATENCY		0
// Slave preferred Link supervision timeout
#define APP_SUPERV_TO		200 // 2s (500*10ms)

#define APP_MAX_MTU			L2C_MIN_LE_MTUSIG
#define APP_FLAGS			0

#define LOCAL_ADDR_TYPE GAPM_PUBLIC_ADDR
#define GAP_device_name "ATMEL_BLE"

struct device_info device;
/*
void prepare_apis(wr_apis* plf_wr_apis)
{
	plf_wr_apis->wr_api32 = dbg_wr_mem_req_handler32;
	plf_wr_apis->wr_api32_reset = dbg_wr_mem_req_handler32_reset;
}*/
//removed __WINC3000__ because clear warning
//#if (!__WINC3000__) && (!SAMB11)
#if (!SAMB11)
const uint32_t fw_patch[] = {
0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 0xE000E100, 
0x0EC906C1, 0x40882001, 0x60084947, 0x4D474770, 0x4F484E47, 
0x68204C48, 0xD47E0400, 0x78004847, 0xD0012801, 0xE7F6BF30, 
0x61282000, 0xF866F002, 0x28006928, 0xD03B6928, 0xD1EC2801, 
0x61B82008, 0x20B8493F, 0x483F6088, 0x483F6070, 0x61011409, 
0x610114C1, 0x6B01483D, 0x02002007, 0x483C4001, 0x08C06AC0, 
0x430107C0, 0x30404831, 0x493A6041, 0x60884838, 0xF848F002, 
0xF84CF002, 0x68004837, 0x20014780, 0x06C04928, 0x49356008, 
0x61882001, 0xF002B662, 0x4B2EF845, 0x69983B80, 0xD4FC00C0, 
0x49304831, 0x69596041, 0xD00F07C9, 0xE00F492F, 0x61281C40, 
0xF002482E, 0x4822F839, 0x60703840, 0x61B8200C, 0x6800482B, 
0xE7FE4780, 0x31114927, 0x48256081, 0x60814928, 0x6841481B, 
0x439114C2, 0x69586041, 0xD40E0740, 0x4924481F, 0x15006281, 
0x69996120, 0x682101C9, 0x4301D502, 0xE00CE001, 0x60214381, 
0x4818E002, 0x60C1491D, 0xF814F002, 0x7801480A, 0xD0FC2901, 
0xBF30E77D, 0x4912E77B, 0x60884818, 0x00004770, 0xE000E100, 
0x100000D0, 0x4000F000, 0x4000E200, 0x40011000, 0x100001E8, 
0x4000F400, 0x00020042, 0x40010000, 0x4000E3C0, 0x4000B1C0, 
0x66656867, 0x4000E040, 0x10000200, 0x40004000, 0x22222222, 
0x4000B040, 0x20222222, 0x002700FF, 0x1000021C, 0x20220733, 
0x00004231, 0x00002222, 0x20222733, 0x0EC906C1, 0x40882001, 
0x60084905, 0xB5104770, 0x48042101, 0x60480709, 0xFFD0F001, 
0x0000BD10, 0xE000E100, 0x00018405, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084930, 0xB5F84770, 0xF001482F, 0x4E2FFF39, 0x4D2F4F2E, 
0x69343EC0, 0xD0512C00, 0xD50205E0, 0x6A00482C, 0x07A04780, 
0xF001D501, 0x0620FF2F, 0x68E8D504, 0x61281C40, 0xFF2EF001, 
0xD50B0720, 0x1C406928, 0x20016168, 0x6BF863F8, 0xD1FC2800, 
0x602869F0, 0xFF26F001, 0xD5010660, 0xFF28F001, 0xD50106E0, 
0xFF2AF001, 0xD5150760, 0x6948491A, 0x431022C0, 0x68A86148, 
0x60A81C40, 0x63F82001, 0x28006BF8, 0x69F0D1FC, 0x20046068, 
0x491361B0, 0x62082000, 0xFF18F001, 0xD00C07E0, 0x1C4068A8, 
0x200160E8, 0xF00161B0, 0x4908FF15, 0x39402000, 0xF0016208, 
0x06A0FF15, 0x2020D5AD, 0xE7AA61B0, 0x0000BDF8, 0xE000E100, 
0x100004E4, 0x400400C0, 0x1000A23C, 0x10001280, 0x40020800, 
0x4000B000, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084926, 0xB5704770, 
0xFC9AF001, 0x26002501, 0x03ED4C23, 0xD00B2800, 0x1E706026, 
0x200863A0, 0xFC94F001, 0x43286960, 0x20086160, 0xFC8EF001, 
0x6AE06066, 0x62E04328, 0x43286B20, 0x62256320, 0xF7FF2008, 
0x201FFFD9, 0xFFD6F7FF, 0xF7FF2015, 0x201CFFD3, 0xFFD0F7FF, 
0x4913BD70, 0x62884811, 0x38C04811, 0x22016A01, 0x62014311, 
0xB5104770, 0x6842480E, 0x430A14C1, 0x4B0B6042, 0x629A4A09, 
0x3AC04A09, 0x24016A13, 0x62134323, 0x68534A08, 0x60531C5B, 
0x438A6842, 0xBD106042, 0xE000E100, 0x40011000, 0x0B080908, 
0x40020240, 0x40010000, 0x4000F040, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x6008491D, 0xB5384770, 0xFC1EF001, 0x28004C1B, 0x4D1BD01F, 
0x478068A8, 0x481A6028, 0x68686120, 0x20034780, 0xFC1CF001, 
0x90002000, 0x227D4816, 0x688100D2, 0xD40406C9, 0x1C499900, 
0x42919100, 0x6880D3F7, 0xD40406C0, 0x68084910, 0x4310064A, 
0xF0016008, 0x480EFC0B, 0x22386881, 0x60814391, 0x22016801, 
0x60014311, 0x6220480A, 0x61602003, 0xF0014610, 0xBD38FC01, 
0xE000E100, 0x4000E000, 0x1000020C, 0x000001FF, 0x4000E300, 
0x4000F040, 0x40025000, 0x002000C0, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x60084901, 0x00004770, 0xE000E100, 0x0EC906C1, 0x40882001, 
0x600849FE, 0x47704770, 0x49FDB5F0, 0x220CB08B, 0x220860CA, 
0x220060CA, 0x4DFA60CA, 0x60A921B8, 0x49F94CFA, 0x49FA6061, 
0x4AFB6069, 0x609149F9, 0x21004AFA, 0x085B6813, 0x6013005B, 
0x62424AF8, 0x62824AF8, 0x23064AF8, 0x22306142, 0x4AF75413, 
0x4AF762C2, 0x4AF76002, 0x4AF76202, 0x4AF76042, 0x48F761C2, 
0x237F6802, 0x439A061B, 0x069B2303, 0x6002431A, 0x23FF6802, 
0x439A041B, 0x045B2321, 0x6002431A, 0x230F6802, 0x439A021B, 
0x021B2307, 0x6002431A, 0x22566803, 0x021B0A1B, 0x60034313, 
0x0048466A, 0x1C495450, 0x2928B2C9, 0x48E5D3F9, 0x210269C0, 
0x49E34308, 0x68E061C8, 0x43082102, 0x200160E0, 0x4BE16160, 
0x601848DF, 0x605A4AE0, 0x609848E0, 0x60D949E0, 0x611949E0, 
0x615E4EE0, 0x61D8619A, 0x621E4EDC, 0x4EDE6259, 0x62DA629E, 
0x4ED96318, 0x635E1E76, 0x4EDB6399, 0x4BD363DE, 0x601A3340, 
0x4BD46058, 0x1E5B4ED0, 0x60B33640, 0x4BD660F1, 0x61726133, 
0x4BCF61B0, 0x61F31E5B, 0x4BD36231, 0x62B26273, 0x4BCB62F0, 
0x63331E9B, 0x4BD06371, 0x63F263B3, 0x33804BC4, 0x4BC66018, 
0x1E9B4EC2, 0x60733680, 0x4BCB60B1, 0x613260F3, 0x4BC16170, 
0x61B31E9B, 0x235D61F1, 0x6233051B, 0x62B06272, 0x1EDB4BBC, 
0x633162F3, 0x63734BC3, 0x63F063B2, 0x4EB54BB8, 0x36C01EDB, 
0x60716033, 0x60B34BBF, 0x613060F2, 0x1EDB4BB3, 0x61B16173, 
0x61F34BBC, 0x62706232, 0x1F1B4BAF, 0x62F162B3, 0x63334BB9, 
0x63B06372, 0x1F1B4BAB, 0x4BB763F3, 0x4EB66019, 0x60734BB6, 
0x60F060B2, 0x1F1B4BA6, 0x61716133, 0x61B34BB3, 0x623061F2, 
0x1F1B4BA2, 0x62B16273, 0x62F34BB0, 0x46336332, 0x4B9E6358, 
0x63B31F5B, 0x4EA963F1, 0x36404BAC, 0x60726033, 0x4B9960B0, 
0x60F31F5B, 0x4BA96131, 0x61B26173, 0x4B9561F0, 0x62331F5B, 
0x4BA66271, 0x62F262B3, 0x63184633, 0x1F9B4B90, 0x63B16373, 
0x63F34BA2, 0x33804B9A, 0x6058601A, 0x4E984B8B, 0x36801F9B, 
0x60F160B3, 0x61334B9D, 0x61B06172, 0x1F9B4B86, 0x623161F3, 
0x055B232F, 0x62B26273, 0x4B8262F0, 0x63331FDB, 0x4B966371, 
0x63F263B3, 0x33C04B8B, 0x4B7D6018, 0x1FDB4E89, 0x607336C0, 
0x4B9160B1, 0x613260F3, 0x4B786170, 0x61B31FDB, 0x4B8E61F1, 
0x62726233, 0x4B7462B0, 0x62F31FDB, 0x4B8B6331, 0x63B26373, 
0x4E7063F0, 0x3E084B89, 0x6059601E, 0x609F4F88, 0x611860DA, 
0x6199615E, 0x61DF4F86, 0x6258621A, 0x62D9629E, 0x631E4E84, 
0x6398635A, 0x3E094E65, 0x4B7E63DE, 0x60193340, 0x605F4F80, 
0x60D8609A, 0x6159611E, 0x619F4F7E, 0x621861DA, 0x6299625E, 
0x62DE4E7C, 0x6358631A, 0x3E0A4E5A, 0x63D9639E, 0x4F794B72, 
0x601F3380, 0x6098605A, 0x611960DE, 0x615F4F76, 0x61D8619A, 
0x6259621E, 0x0500205F, 0x62DA6298, 0x6319494E, 0x46194630, 
0x484E6348, 0x486F6388, 0x486563C8, 0x600230C0, 0x60414948, 
0x60811E71, 0x60C14948, 0x6101496A, 0x49446142, 0x1E716181, 
0x494461C1, 0x49676201, 0x62826241, 0x62C1493F, 0x63011E71, 
0x6341493F, 0x63814963, 0x496363C2, 0x6008483A, 0x1EB14861, 
0x49606041, 0x60884839, 0x60C8485F, 0x4835610A, 0x1EB06148, 
0x48356188, 0x4B5D61C8, 0x6018485B, 0x4830605A, 0x6098380D, 
0x6119495A, 0x04F626B9, 0x619A615E, 0x625961D8, 0x629E4E57, 
0x631862DA, 0x4E566399, 0x4B5263DE, 0x601A3340, 0x60D96058, 
0x611E4E53, 0x6198615A, 0x4E526219, 0x629A625E, 0x635962D8, 
0x639E4E50, 0x4B4963DA, 0x60183380, 0x4E4E6099, 0x611A60DE, 
0x61D96158, 0x621E4E4C, 0x6298625A, 0x4E4B6319, 0xE095635E, 
0xE000E100, 0x4000E200, 0x4000F400, 0x00020042, 0x4000F000, 
0x31888C02, 0x66656867, 0x4000E040, 0x40041800, 0x0001769B, 
0x0001768D, 0x00017403, 0x0001740B, 0x000173D5, 0x000173EF, 
0x000173F1, 0x10008BBF, 0x40040080, 0x40020000, 0x05C62762, 
0x40022800, 0x0F141607, 0x6A029154, 0x00009D82, 0x0F60010B, 
0x05C76276, 0x05C89D8A, 0x05C9D89E, 0x05CB13B1, 0x05CC4EC5, 
0x05CD89D9, 0x05CEC4EC, 0x05D13B14, 0x05D27627, 0x05D3B13B, 
0x05D4EC4F, 0x40022900, 0x05D62762, 0x05D76276, 0x05D89D8A, 
0x05D9D89E, 0x05DB13B1, 0x05DC4EC5, 0x05DD89D9, 0x05DEC4EC, 
0x05E13B14, 0x05E27627, 0x05E3B13B, 0x05E4EC4F, 0x40022A00, 
0x05E62762, 0x05E76276, 0x05E89D8A, 0x05E9D89E, 0x05EB13B1, 
0x05EC4EC5, 0x05ED89D9, 0x05EEC4EC, 0x05F13B14, 0x05F27627, 
0x05F3B13B, 0x05F4EC4F, 0x40022B00, 0x05F62762, 0x05C6C4EC, 
0x40022C00, 0x03600311, 0x05C93B14, 0x05CA7627, 0x05CBB13B, 
0x05CCEC4F, 0x05CE2762, 0x05CF6276, 0x05D09D8A, 0x05D1D89E, 
0x63D8639A, 0x60594BFB, 0x4BFB4EFA, 0x60F260B3, 0x61B16130, 
0x61F34BF9, 0x62706232, 0x4BF862F1, 0x63726333, 0x4BF363B0, 
0x60193340, 0x605E4EF5, 0x60D8609A, 0x26BB6159, 0x619E04F6, 
0x621861DA, 0x4EF16299, 0x631A62DE, 0x63D96358, 0x4EEF4BE9, 
0x601E3380, 0x6098605A, 0x4EED6119, 0x619A615E, 0x625961D8, 
0x629E4EEB, 0x631862DA, 0x4EEA6399, 0x4BE063DE, 0x601A33C0, 
0x60D96058, 0x611E4EE7, 0x6198615A, 0x4EE66219, 0x629A625E, 
0x635962D8, 0x639E4EE4, 0x4BE463DA, 0x60996018, 0x60DE4EE3, 
0x6158611A, 0x4EE261D9, 0x625A621E, 0x63196298, 0x635E4EE0, 
0x63D8639A, 0x33404BDB, 0x4EDA6059, 0x36404BDD, 0x60F260B3, 
0x61B16130, 0x04DB23BD, 0x623261F3, 0x62F16270, 0x63334BD8, 
0x63B06372, 0x33804BD1, 0x4ED66019, 0x609A605E, 0x615960D8, 
0x619E4ED4, 0x621861DA, 0x4ED36299, 0x631A62DE, 0x63D96358, 
0x4ED14BC8, 0x601E33C0, 0x6098605A, 0x4ECF6119, 0x619A615E, 
0x625961D8, 0x629E4ECD, 0x631862DA, 0x4ECC6399, 0x4BCC63DE, 
0x6058601A, 0x4ECB60D9, 0x615A611E, 0x62196198, 0x625E4EC9, 
0x62D8629A, 0x4EC86359, 0x63DA639E, 0x33404BC3, 0x60996018, 
0x4BC54EC1, 0x60F33640, 0x61706132, 0x49C361F1, 0x62726231, 
0x49C262B0, 0x20FF6331, 0x30C949C1, 0x48C06008, 0x604149C0, 
0x48C049BE, 0x48BD6088, 0x60C149BD, 0x61072700, 0x61876147, 
0x200361C7, 0x040049BB, 0x48B662C8, 0x20616028, 0x01C049B6, 
0x61C83920, 0x48B749B8, 0x48B86208, 0x48B86248, 0x48B86288, 
0x48B862C8, 0x48B86308, 0x48B86348, 0x48B86388, 0x49B063C8, 
0x314048B7, 0x48B76008, 0x49B86048, 0x604848B6, 0x49B72011, 
0x610802C0, 0x614848B6, 0x49B42009, 0x31400280, 0x48B56108, 
0x600149B3, 0x49B448B5, 0x48AD6001, 0x30CF49B3, 0x60083180, 
0x608848B2, 0x60C848B2, 0x48B249AA, 0x49A96088, 0x60883140, 
0x200149A6, 0x600839C0, 0x49AE48A3, 0x61081C80, 0x49A260C8, 
0x394048AC, 0x62C863C8, 0x62886248, 0x301A48A9, 0x49AA6348, 
0x628848A8, 0x48A9499B, 0x20FF6108, 0x30814999, 0x60483140, 
0x60882001, 0x200249A3, 0x63083140, 0x306D20FF, 0x20106008, 
0x20FF6108, 0x30F94991, 0x608839C0, 0x02C02029, 0x489D6048, 
0x489C6087, 0x60073040, 0x489B499C, 0x489C6148, 0x489C6188, 
0x499761C8, 0x6188489B, 0x49972097, 0x62080080, 0x498A624F, 
0x31802001, 0x49736148, 0x3920202D, 0x4E846088, 0x6B303E40, 
0x43880149, 0x63304308, 0x10C96B30, 0x43084388, 0x20216330, 
0x0140497D, 0x6B306048, 0x03092103, 0x63304388, 0x15716B30, 
0x63304388, 0x10496B30, 0x63304388, 0x21806B30, 0x43084388, 
0x6B306330, 0x43882160, 0x6B306330, 0x43882110, 0x6B306330, 
0x00400840, 0x6B706330, 0x0C00497D, 0x43080400, 0x6B706370, 
0x0409211F, 0x21014388, 0x43080449, 0x6B306370, 0x43880109, 
0x63304308, 0xFEF8F000, 0xFEFCF000, 0xFF00F000, 0x03F16B30, 
0x63304388, 0x10C96B30, 0x43084388, 0x6B306330, 0x43880109, 
0x486C6330, 0x47806800, 0x486B60A7, 0x486B6007, 0x21046980, 
0x49694308, 0x69886188, 0x43082108, 0x61884966, 0x68004864, 
0x43082180, 0x60084962, 0x68014608, 0xD4FC0609, 0x4A606901, 
0x03FF2701, 0x43B96993, 0x43B32608, 0x69936193, 0x43B32604, 
0x68026193, 0x431A2380, 0x68026002, 0xD4FC0612, 0x43BA6902, 
0x686A6102, 0x330123FF, 0x606A439A, 0x690625E1, 0x43BE026D, 
0xF0004851, 0x4607FEBB, 0x46294377, 0xF0004638, 0xB281FEB5, 
0x43484628, 0x20001A3A, 0xE098092B, 0x40022CC0, 0x05D313B1, 
0x05D44EC5, 0x05D589D9, 0x05D6C4EC, 0x05D93B14, 0x05DA7627, 
0x05DBB13B, 0x05DCEC4F, 0x05DE2762, 0x05DF6276, 0x05E09D8A, 
0x05E1D89E, 0x40022DC0, 0x05E313B1, 0x05E44EC5, 0x05E589D9, 
0x05E6C4EC, 0x05E93B14, 0x05EA7627, 0x05EBB13B, 0x05ECEC4F, 
0x05EE2762, 0x05EF6276, 0x05F09D8A, 0x05F1D89E, 0x40022EC0, 
0x05F313B1, 0x05F44EC5, 0x05F589D9, 0x05F6C4EC, 0x05C6C4EC, 
0x7F600007, 0x40023000, 0x40020020, 0x100001C8, 0x40041A80, 
0x03020100, 0x40030000, 0x07060504, 0x0B0A0908, 0x0F0E0D0C, 
0x13121110, 0x17161514, 0x1B1A1918, 0x1F1E1D1C, 0x23222120, 
0x27262524, 0x00010001, 0x400250C0, 0x40020800, 0x001414CE, 
0x08600140, 0x40040080, 0xC30041A0, 0x40041800, 0x1E1E0101, 
0x00001111, 0x00000EE5, 0x40024A00, 0x00010208, 0x0000022F, 
0x40025200, 0x00020002, 0x40024000, 0xCCDCF0FF, 0x40041900, 
0x7289A1B8, 0x00005A59, 0x00001D5A, 0x00000AF2, 0x10000218, 
0x4000C000, 0x4000B000, 0x018CBA80, 0xB2C01C40, 0x42931AD2, 
0x1C40D3FA, 0x48FF0843, 0x62022200, 0x00C96282, 0x62414319, 
0x48FC49FD, 0x6A0861C8, 0x0A4022FF, 0x32C90240, 0x02CA4310, 
0x62084390, 0x62084310, 0x606048F7, 0x200F49F7, 0x48F660C8, 
0x384049F6, 0x49F66041, 0x49F76001, 0x604848F5, 0xBDF0B00B, 
0x48F5B5F8, 0x61C32308, 0x388048F2, 0x08496801, 0x60010049, 
0x49F148F2, 0x48F26041, 0x227F6801, 0x43910612, 0x06922203, 
0x60014311, 0x22FF6801, 0x43910412, 0x04522221, 0x60014311, 
0x220F6801, 0x43910212, 0x02122207, 0x60014311, 0x21566802, 
0x02120A12, 0x6002430A, 0x69C849D8, 0x43102202, 0x48E161C8, 
0x60042400, 0x69914AE0, 0x43392704, 0x69916191, 0x61914319, 
0x25806801, 0x60014329, 0x06096801, 0x6901D4FC, 0x03F62601, 
0x699643B1, 0x6196439E, 0x43BB6993, 0x68026193, 0x431A2380, 
0x68026002, 0xD4FC0612, 0x22016903, 0x439303D2, 0x4BCB6103, 
0x11D5685E, 0x605E43AE, 0x690625E1, 0x4396026D, 0xF00048CA, 
0x4607FD87, 0x46294377, 0xF0004638, 0xB281FD81, 0x43484628, 
0x20001A3A, 0xE002092B, 0xB2C01C40, 0x42931AD2, 0x1C40D3FA, 
0x48B00842, 0x23006204, 0x00C96283, 0x62414311, 0x48BC4BBD, 
0x48BD6018, 0x49BD6058, 0x4ABD6099, 0x4ABD60DA, 0x4DBD611A, 
0x6198615D, 0x4DB961D9, 0x625A621D, 0x629D4DBA, 0x631962D8, 
0x1E6D4DB5, 0x639A635D, 0x63DD4DB7, 0x33404BAF, 0x60596018, 
0x4DAD4BB0, 0x35401E5B, 0x60EA60AB, 0x612B4BB2, 0x61A96168, 
0x1E5B4BAB, 0x622A61EB, 0x626B4BAF, 0x62E962A8, 0x1E9B4BA7, 
0x636A632B, 0x63AB4BAC, 0x4BA163E8, 0x60193380, 0x4D9F4BA2, 
0x35801E9B, 0x60AA606B, 0x60EB4BA7, 0x61696128, 0x1E9B4B9D, 
0x61EA61AB, 0x051B235D, 0x6268622B, 0x4B9962A9, 0x62EB1EDB, 
0x4BA0632A, 0x63A8636B, 0x4B9563E9, 0x1EDB4D91, 0x602B35C0, 
0x4B9C606A, 0x60E860AB, 0x4B906129, 0x616B1EDB, 0x4B9961AA, 
0x622861EB, 0x4B8C6269, 0x62AB1F1B, 0x4B9662EA, 0x6368632B, 
0x4B8863A9, 0x63EB1F1B, 0x601A4B93, 0x4B934D92, 0x60A8606B, 
0x4B8360E9, 0x612B1F1B, 0x4B90616A, 0x61E861AB, 0x4B7F6229, 
0x626B1F1B, 0x4B8D62AA, 0x632862EB, 0x6359462B, 0x1F5B4B7A, 
0x63EA63AB, 0x4B894D85, 0x602B3540, 0x60A96068, 0x1F5B4B75, 
0x612A60EB, 0x616B4B85, 0x61E961A8, 0x1F5B4B71, 0x626A622B, 
0x62AB4B82, 0x462B62E8, 0x4B6D6319, 0x636B1F9B, 0x4E7863AA, 
0x36404D7E, 0x4D7663F5, 0x60283580, 0x60AB6069, 0x4E7360EA, 
0x36804D7A, 0x61706135, 0x61F361B1, 0x232F6232, 0x6273055B, 
0x62F162B0, 0x1FED4D5F, 0x63726335, 0x63B34B73, 0x4B6963F0, 
0x601933C0, 0x609A605D, 0x60DE4E70, 0x61596118, 0x61DA619D, 
0x621E4E6E, 0x62996258, 0x631A62DD, 0x635D4D6C, 0x63D96398, 
0x4B6B4D51, 0x601D3D08, 0x4E6A605A, 0x60D8609E, 0x615D6119, 
0x4E68619A, 0x621861DE, 0x629D6259, 0x4D6662DA, 0x6358631D, 
0x4D476399, 0x63DD3D09, 0x33404B5F, 0x4E62601A, 0x6098605E, 
0x611D60D9, 0x4E60615A, 0x61D8619E, 0x625D6219, 0x4D5E629A, 
0x631862DD, 0x4D3C6359, 0x639D3D0A, 0x4B5463DA, 0x33804E5A, 
0x6058601E, 0x60DD6099, 0x4858611A, 0x48336158, 0x460A6198, 
0x621D61DA, 0x625D4D33, 0x0509215F, 0x62D86299, 0x492F631A, 
0x6359390A, 0x4950639D, 0x494663D9, 0x600831C0, 0x4B2A604A, 
0x608B3B0B, 0x4E4C60CD, 0x6148610E, 0x61CB618A, 0x4E4A620D, 
0x6288624E, 0x630B62CA, 0x4B48634D, 0x63C8638B, 0x600A4947, 
0x3B0C4B1F, 0x608D604B, 0x60CB4B45, 0x614A6108, 0x3A0C4A1B, 
0x61CD618A, 0x49424B43, 0x60586019, 0x390D4916, 0x4A416099, 
0x25B9611A, 0xE07F04ED, 0x40004000, 0x03007080, 0x40020000, 
0x00020043, 0x40020840, 0x74488E43, 0x000022D2, 0x00000303, 
0x40041880, 0x40024000, 0x31888C02, 0x4000F400, 0x40040080, 
0x4000C000, 0x4000B000, 0x018CBA80, 0x05C62762, 0x40022800, 
0x0F141607, 0x6A029154, 0x00009D82, 0x0F60010B, 0x05C76276, 
0x05C89D8A, 0x05C9D89E, 0x05CB13B1, 0x05CC4EC5, 0x05CD89D9, 
0x05CEC4EC, 0x05D13B14, 0x05D27627, 0x05D3B13B, 0x05D4EC4F, 
0x40022900, 0x05D62762, 0x05D76276, 0x05D89D8A, 0x05D9D89E, 
0x05DB13B1, 0x05DC4EC5, 0x05DD89D9, 0x05DEC4EC, 0x05E13B14, 
0x05E27627, 0x05E3B13B, 0x05E4EC4F, 0x40022A00, 0x05E62762, 
0x05E76276, 0x05E89D8A, 0x05E9D89E, 0x05EB13B1, 0x05EC4EC5, 
0x05ED89D9, 0x05EEC4EC, 0x05F13B14, 0x05F27627, 0x05F3B13B, 
0x05F4EC4F, 0x40022B00, 0x05F62762, 0x05C6C4EC, 0x40022C00, 
0x03600311, 0x6198615D, 0x625A61D9, 0x629D4DFE, 0x631962D8, 
0x4DFD639A, 0x4BFD63DD, 0x60596018, 0x4DFB60DA, 0x612B4BFB, 
0x61A96168, 0x4BFA622A, 0x62A8626B, 0x636A62E9, 0x63AB4BF8, 
0x4BF463E8, 0x60193340, 0x4DF2609A, 0x35404BF5, 0x612860EB, 
0x61EA6169, 0x622B4BF3, 0x62A96268, 0x4BF2632A, 0x63A8636B, 
0x4BEA63E9, 0x605A3380, 0x4BEF4DE8, 0x60AB3580, 0x612960E8, 
0x4BED61AA, 0x622861EB, 0x62EA6269, 0x632B4BEB, 0x63A96368, 
0x33C04BE0, 0x4DDF601A, 0x35C04BE8, 0x60A8606B, 0x616A60E9, 
0x04DB23BB, 0x61E861AB, 0x62AA6229, 0x62EB4BE3, 0x63696328, 
0x4DE363EA, 0x602B4BE1, 0x60A96068, 0x4BE1612A, 0x61A8616B, 
0x626A61E9, 0x62AB4BDF, 0x632962E8, 0x4BDE63AA, 0x4BDA63EB, 
0x60183340, 0x60DA6059, 0x4BDB4DD7, 0x612B3540, 0x61A96168, 
0x4BD9622A, 0x62A8626B, 0x636A62E9, 0x63AB4BD7, 0x4BD063E8, 
0x60193380, 0x4DCE609A, 0x35804BD4, 0x612860EB, 0x61EA6169, 
0x622B4BD2, 0x62A96268, 0x4BD1632A, 0x63A8636B, 0x4BC663E9, 
0x605A33C0, 0x4BCE4DC4, 0x60AB35C0, 0x612960E8, 0x23BD61AA, 
0x61EB04DB, 0x62696228, 0x4BC962EA, 0x6368632B, 0x4BC863A9, 
0x4DC7601A, 0x606B4BC7, 0x60E960A8, 0x4BC6616A, 0x61E861AB, 
0x62AA6229, 0x62EB4BC4, 0x63696328, 0x4DBF63EA, 0x35404BC2, 
0x6068602B, 0x612A60A9, 0x616B4BC0, 0x61E961A8, 0x4BBF626A, 
0x62E862AB, 0x63AA6329, 0x63EB4BBD, 0x33804BB5, 0x60596018, 
0x4DB360DA, 0x35804BBA, 0x6168612B, 0x622A61A9, 0x626B4BB8, 
0x62E962A8, 0x4BB7636A, 0x63E863AB, 0x33C04BAB, 0x609A6019, 
0x4BB44DA9, 0x60EB35C0, 0x61696128, 0x4AB261EA, 0x6268622A, 
0x48B162A9, 0x20FF6328, 0x30C949B0, 0x48B06008, 0x48AE6048, 
0x608149AF, 0x48AD49AC, 0x610C60C8, 0x61482000, 0x61C86188, 
0x48AB2103, 0x62C10409, 0x382048A7, 0x200269C1, 0x43814AA5, 
0x61D13A20, 0x49A32261, 0x392001D2, 0x4AA561CA, 0x605149A3, 
0x49A42211, 0x610A02D2, 0x49A34AA2, 0x22096151, 0x029249A0, 
0x610A3140, 0x4AA049A1, 0x49A2600A, 0x600A4AA0, 0x4AA04999, 
0x328031CF, 0x499F6011, 0x499F6091, 0x4A9760D1, 0x6091499E, 
0x32404A95, 0x49936091, 0x39C02201, 0x4A90600A, 0x1C924B9A, 
0x60DA611A, 0x4A994B8E, 0x63DA3B40, 0x625A62DA, 0x4A96629A, 
0x635A321A, 0x4A954B96, 0x4B88629A, 0x611A4A95, 0x4B8622FF, 
0x33403281, 0x2201605A, 0x4A90609A, 0x63103240, 0x306D20FF, 
0x20106010, 0x20FF6110, 0x608830F9, 0x02C02029, 0x488B6048, 
0x60812100, 0x49894608, 0x60083140, 0x49884889, 0x49896141, 
0x49896181, 0x4A8461C1, 0x61914988, 0x00892197, 0x21006201, 
0x48776241, 0x30802101, 0x496B6141, 0x3920202D, 0x48716088, 
0x6B003840, 0x43880149, 0x496E4308, 0x63083940, 0x21016B08, 
0x438804C9, 0x496A4308, 0x63083940, 0x49682021, 0x60480140, 
0x38404866, 0x21036B00, 0x43880309, 0x39404963, 0x6B086308, 
0x43881549, 0x39404960, 0x6B086308, 0x43881589, 0x3940495D, 
0x6B086308, 0x43882180, 0x495A4308, 0x63083940, 0x21606B08, 
0x49574388, 0x63083940, 0x21106B08, 0x49544388, 0x63083940, 
0x08406B08, 0x63080040, 0x49616B48, 0x04000C00, 0x494E4308, 
0x63483940, 0x211F6B48, 0x43880409, 0x04492101, 0x49494308, 
0x63483940, 0x03C96B08, 0x43084388, 0x39404945, 0xF0006308, 
0x4855F9A1, 0x47806800, 0x48544939, 0x61C83920, 0x21FF6A08, 
0x02400A40, 0x430831C9, 0x07092101, 0x43884A33, 0x62103A20, 
0x62104308, 0x494C4842, 0x60483041, 0x200F4933, 0x60C83140, 
0x48494931, 0x48496048, 0xE0916008, 0x05C93B14, 0x05CA7627, 
0x40022C40, 0x05CBB13B, 0x05CCEC4F, 0x05CE2762, 0x05CF6276, 
0x05D09D8A, 0x05D1D89E, 0x05D313B1, 0x05D44EC5, 0x05D589D9, 
0x05D6C4EC, 0x05D93B14, 0x05DA7627, 0x40022D40, 0x05DBB13B, 
0x05DCEC4F, 0x05DE2762, 0x05DF6276, 0x05E09D8A, 0x05E1D89E, 
0x05E313B1, 0x05E44EC5, 0x05E589D9, 0x05E6C4EC, 0x05E93B14, 
0x40022E40, 0x05EA7627, 0x05EBB13B, 0x05ECEC4F, 0x05EE2762, 
0x05EF6276, 0x05F09D8A, 0x05F1D89E, 0x05F313B1, 0x05F44EC5, 
0x05F589D9, 0x05F6C4EC, 0x05C6C4EC, 0x7F600007, 0x40023000, 
0x40020020, 0x100001C8, 0x40041A80, 0x00010001, 0x400250C0, 
0x40020800, 0x001414CE, 0x08600140, 0x40040080, 0xC30041A0, 
0x40041800, 0x1E1E0101, 0x00001111, 0x00000EE5, 0x40024A00, 
0x00010208, 0x0000022F, 0x40025200, 0x00020002, 0x40024000, 
0xCCDCF0FF, 0x40041900, 0x7289A1B8, 0x00005A59, 0x00001D5A, 
0x00000AF2, 0x10000218, 0x03007080, 0x4000F000, 0x74488E43, 
0x000022D2, 0x49034802, 0x604830D4, 0x0000BDF8, 0x0000022F, 
0x40041880, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x0EC906C1, 0x40882001, 0x60084901, 0x00004770, 
0xE000E100, 0x4801B403, 0xBD019001, 0x000000D5, 0x4801B403, 
0xBD019001, 0x0001422D, 0x4801B403, 0xBD019001, 0x000141D1, 
0x4801B403, 0xBD019001, 0x000003DF, 0x4801B403, 0xBD019001, 
0x0001466D, 0x4801B403, 0xBD019001, 0x0001442B, 0x4801B403, 
0xBD019001, 0x0000061D, 0x4801B403, 0xBD019001, 0x00017DD9, 
0x4801B403, 0xBD019001, 0x00004385, 0x4801B403, 0xBD019001, 
0x00004361, 0x4801B403, 0xBD019001, 0x00004373, 0x4801B403, 
0xBD019001, 0x00004397, 0x4801B403, 0xBD019001, 0x0000307D, 
0x4801B403, 0xBD019001, 0x000166AD, 0x4801B403, 0xBD019001, 
0x000149EF, 0x4801B403, 0xBD019001, 0x000166E7, 0x4801B403, 
0xBD019001, 0x00014685, 0x4801B403, 0xBD019001, 0x00014193, 
0x4801B403, 0xBD019001, 0x00014631, 0x4801B403, 0xBD019001, 
0x00014673, 0x4801B403, 0xBD019001, 0x0001464F, 0x4801B403, 
0xBD019001, 0x000168BD, 0x4801B403, 0xBD019001, 0x00016751, 
0x4801B403, 0xBD019001, 0x00017129, 0x4801B403, 0xBD019001, 
0x00018009, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000};





static void boot_delay(void)
{
	volatile uint32_t v1=0,v2=0,v3=0;

	for(v1=0;v1<50000;v1++)
	{
		for(v2=0;v2<10000;v2++)
		{
			v3 = v1 + v2;
			v3 = v3 - 2 + v1;
		}
	}
}

static void fw_patch_download(uint32_t* patch, uint32_t patch_size/*, void* plf_wr_apis*/)
{
	volatile uint32_t i=0, remaining=0;
	volatile uint32_t fp_val;

	/*Download patches*/
	remaining = patch_size;
	i=0;
	while(remaining > (128/1))
	{
		dbg_wr_mem_req_handler32(0x10008000+i*4, &patch[i], (128/1));
		i+=(32/1);
		remaining -= (128/1);
	}
	dbg_wr_mem_req_handler32(0x10008000+i*4, &patch[i], (uint8_t)(remaining&0x000000FF));
		
	/*Updare fn pointers*/
	/*reset_isr*/
	fp_val = 0x100081ab;
	dbg_wr_mem_req_handler32(0x10000004, (uint32_t *)&fp_val, 4);

	/*twosc_delay*/
	fp_val = 0x02711f40;
	dbg_wr_mem_req_handler32(0x100000fc, (uint32_t *)&fp_val, 4);
	/*ULP_wakeup_delay*/
	fp_val = 10;
	dbg_wr_mem_req_handler32(0x1000022c, (uint32_t *)&fp_val, 4);
	/*system_sleep*/
	fp_val = 0x10008023;
	dbg_wr_mem_req_handler32(0x100000e4, (uint32_t *)&fp_val, 4);
	/*early_entry*/
	fp_val = 0x10008133;
	dbg_wr_mem_req_handler32(0x100000e8, (uint32_t *)&fp_val, 4);
	/*rwble_isr*/
	fp_val = 0x100082eb;
	dbg_wr_mem_req_handler32(0x10000110, (uint32_t *)&fp_val, 4);
	/*intc_init*/
	fp_val = 0x10008897;
	dbg_wr_mem_req_handler32(0x10000200, (uint32_t *)&fp_val, 4);
	/*ble_osc_en_irq_fn_patch*/
	fp_val = 0x100088eb;
	dbg_wr_mem_req_handler32(0x100001ec, (uint32_t *)&fp_val, 4);
	/*ble_core_reset_irq_fn_patch*/
	fp_val = 0x100088ff;
	dbg_wr_mem_req_handler32(0x100001fc, (uint32_t *)&fp_val, 4);
	/*pwr_init*/
	fp_val = 0x1000898f;
	dbg_wr_mem_req_handler32(0x10000218, (uint32_t *)&fp_val, 4);
	/*rf_init*/
	fp_val = 0x10008bc1;
	dbg_wr_mem_req_handler32(0x1000024c, (uint32_t *)&fp_val, 4);
	/*ulp_rf_init*/
	fp_val = 0x10009659;
	dbg_wr_mem_req_handler32(0x10000250, (uint32_t *)&fp_val, 4);

	/*interrupt map pattern*/
	fp_val = 0x20101985;
	dbg_wr_mem_req_handler32(0x10000000, (uint32_t *)&fp_val, 4);

	/*issue sw reset*/
	fp_val = 0x5fa0004;
	dbg_wr_mem_req_handler32_reset(0xe000ed0c, (uint32_t *)&fp_val, 4);
	
	/*#ifndef WIN32
		for(i=0; i<10000; i++)
			fp_val++;
	#else  
		boot_delay();
	#endif*/
}



const uint32_t fw_patch_a3[] = {
	0x2101B510, 0x07094802, 0xF0006048, 0xBD10FDF7, 0x00018119,
	0xB5F04770, 0xB08B4AFE, 0x15936851, 0x60514319, 0x21004CFC,
	0x086D6825, 0x6025006D, 0x62444CFA, 0x62844CFA, 0x25064CFA,
	0x24306144, 0x4CF95425, 0x4CF962C4, 0x4CF96004, 0x4CF96204,
	0x4CF96044, 0x61C44FF9, 0x247F6838, 0x43A00624, 0x4320066C,
	0x68386038, 0x042424FF, 0x242143A0, 0x43200464, 0x68386038,
	0x0224240F, 0x240743A0, 0x43200224, 0x683C6038, 0x0A242056,
	0x43040224, 0x466C603C, 0x54600048, 0xB2C91C49, 0xD3F92928,
	0x69E04CE7, 0x43082102, 0x48E661E0, 0x60C4240D, 0x684448E5,
	0x432C2503, 0x68C46044, 0x60C4430C, 0x43186850, 0x48E16050,
	0x25806801, 0x60014329, 0x06096801, 0x6901D4FC, 0x03F62601,
	0x43B16854, 0x6054439C, 0x25806804, 0x6004432C, 0x06246804,
	0x6904D4FC, 0x03F62601, 0x610443B4, 0x68544AC5, 0x439C1593,
	0x24E16054, 0x02646905, 0x48D043B5, 0xFD7AF000, 0x436E4606,
	0x46304621, 0xFD74F000, 0x4620B281, 0x1A324348, 0x09232000,
	0x1C40E002, 0x1AD2B2C0, 0xD3FA4293, 0x08421C40, 0x230048C5,
	0x23036203, 0x00C96283, 0x62414311, 0x48C24BC3, 0x48C36018,
	0x49C36058, 0x4AC36099, 0x4AC360DA, 0x4CC3611A, 0x6198615C,
	0x4CBF61D9, 0x625A621C, 0x629C4CC0, 0x631962D8, 0x1E644CBB,
	0x639A635C, 0x63DC4CBD, 0x33404BB5, 0x60596018, 0x4CB34BB6,
	0x34401E5B, 0x60E260A3, 0x61234BB8, 0x61A16160, 0x1E9B4BB1,
	0x622261E3, 0x62634BB5, 0x62E162A0, 0x1E9B4BAD, 0x63626323,
	0x63A34BB2, 0x4BA763E0, 0x60193380, 0x4CA54BA8, 0x34801E9B,
	0x60A26063, 0x60E34BAD, 0x61616120, 0x1EDB4BA3, 0x61E261A3,
	0x051B235D, 0x62606223, 0x4B9F62A1, 0x62E31EDB, 0x4BA66322,
	0x63A06363, 0x4B9B63E1, 0x1F1B4C97, 0x602334C0, 0x4BA26062,
	0x60E060A3, 0x4C966121, 0x1F244B92, 0x615C33C0, 0x4C90619A,
	0x34C04B9D, 0x622061E3, 0x4B906261, 0x62A31F1B, 0x4B9A62E2,
	0x63606323, 0x4B8C63A1, 0x63E31F5B, 0x601A4B97, 0x4B974C96,
	0x60A06063, 0x4B8760E1, 0x61231F5B, 0x4B946162, 0x61E061A3,
	0x4B836221, 0x62631F5B, 0x4B9162A2, 0x632062E3, 0x63594623,
	0x1F9B4B7E, 0x63E263A3, 0x4B8D4C89, 0x60233440, 0x60A16060,
	0x1F9B4B79, 0x612260E3, 0x61634B89, 0x61E161A0, 0x1FDB4B75,
	0x62626223, 0x62A34B86, 0x462362E0, 0x4B716319, 0x63631FDB,
	0x4B8363A2, 0x4B7B63E3, 0x60183380, 0x4B6C6059, 0x1FDB4C78,
	0x60A33480, 0x4B7E60E2, 0x61606123, 0x4C6761A1, 0x3C084B73,
	0x61DC3380, 0x232F621A, 0x055B4D70, 0x626B3580, 0x62E962A8,
	0x636A632C, 0x63AB4B75, 0x4B6B63E8, 0x601933C0, 0x609A605C,
	0x60DC4C72, 0x61596118, 0x3C094C59, 0x61DA619C, 0x621D4D6F,
	0x62996258, 0x631A62DC, 0x635C4C6D, 0x63D96398, 0x4B6C4C52,
	0x601C3C0A, 0x4D6B605A, 0x60D8609D, 0x615C6119, 0x4D69619A,
	0x621861DD, 0x629C6259, 0x4C6762DA, 0x6358631C, 0x4C486399,
	0x63DC3C0B, 0x33404B60, 0x4D63601A, 0x6098605D, 0x611C60D9,
	0x4D61615A, 0x61D8619D, 0x625C6219, 0x4C5F629A, 0x631862DC,
	0x4C3D6359, 0x639C3C0C, 0x4B5563DA, 0x33804D5B, 0x6058601D,
	0x60DC6099, 0x4859611A, 0x48346158, 0x61D96198, 0x4611621C,
	0x215F6259, 0x62990509, 0x493062D8, 0x1E616319, 0x46116359,
	0x49516399, 0x494763D9, 0x600831C0, 0x492A4A45, 0x605132C0,
	0x60911E61, 0x60D14929, 0x6111494B, 0x49256150, 0x1EA16191,
	0x492561D1, 0x49486211, 0x46116251, 0x49206288, 0x493A62D1,
	0x31C01EA2, 0x4A38630A, 0x32C0491E, 0x49366351, 0x31C04A41,
	0x63C8638A, 0x49184A40, 0x1EA16011, 0x49186051, 0x493E6091,
	0xE07B60D1, 0x4000F400, 0x40041800, 0x00017407, 0x000173F9,
	0x0001716F, 0x00017177, 0x00017141, 0x0001715B, 0x0001715D,
	0x10008015, 0x40040080, 0x40020000, 0x40020840, 0x4000F000,
	0x4000C000, 0x018CBA80, 0x40004000, 0x05C62762, 0x40022800,
	0x0F141A07, 0x6A0391EF, 0x0000D3A0, 0x0F600113, 0x05C76276,
	0x05C89D8A, 0x05C9D89E, 0x05CB13B1, 0x05CC4EC5, 0x05CD89D9,
	0x05CEC4EC, 0x05D13B14, 0x05D27627, 0x05D3B13B, 0x05D4EC4F,
	0x40022900, 0x05D62762, 0x05D76276, 0x05D89D8A, 0x05D9D89E,
	0x05DB13B1, 0x05DC4EC5, 0x05DD89D9, 0x05DEC4EC, 0x05E13B14,
	0x05E27627, 0x05E3B13B, 0x05E4EC4F, 0x40022A00, 0x05E62762,
	0x05E76276, 0x05E89D8A, 0x05E9D89E, 0x05EB13B1, 0x05EC4EC5,
	0x05ED89D9, 0x05EEC4EC, 0x05F13B14, 0x05F27627, 0x05F3B13B,
	0x05F4EC4F, 0x40022B00, 0x05F62762, 0x49FE6110, 0x1EE16151,
	0x49FD6191, 0x4AFE61D1, 0x601149FC, 0x4CF96050, 0x60943C18,
	0x60D149FB, 0x4AFB4BF9, 0x23B9611A, 0x04DB4DF7, 0x61A8616B,
	0x622961EC, 0x4BF7626A, 0x62E862AB, 0x632B4623, 0x63AA6369,
	0x63EB4BF4, 0x33404BEF, 0x46256018, 0x6099605D, 0x4DF160DA,
	0x6158611D, 0x619D4625, 0x621A61D9, 0x625D4DEE, 0x46256298,
	0x631962DD, 0x4DEC635A, 0x63D8639D, 0x46254BE3, 0x601D3380,
	0x609A6059, 0x60DD4DE8, 0x46256118, 0x6199615D, 0x4DE661DA,
	0x6258621D, 0x629D4625, 0x631A62D9, 0x635D4DE3, 0x46256398,
	0x4BD763DD, 0x601933C0, 0x4DE0605A, 0x60D8609D, 0x611D4625,
	0x619A6159, 0x61DD4DDD, 0x46256218, 0x6299625D, 0x4DDB62DA,
	0x6358631D, 0x639D4625, 0x4BD963D9, 0x4DD9601A, 0x6098605D,
	0x60DD4625, 0x615A6119, 0x04ED25BB, 0x61D8619D, 0x621D4625,
	0x629A6259, 0x62DD4DD2, 0x46256318, 0x6399635D, 0x4BCD63DA,
	0x33404DCF, 0x6058601D, 0x609D4625, 0x611A60D9, 0x615D4DCC,
	0x46256198, 0x621961DD, 0x4DCA625A, 0x62D8629D, 0x631D4625,
	0x639A6359, 0x63DD4DC7, 0x33804BC0, 0x46256018, 0x6099605D,
	0x4DC460DA, 0x6158611D, 0x619D4625, 0x621A61D9, 0x625D4DC1,
	0x46256298, 0x631962DD, 0x4DBF635A, 0x63D8639D, 0x46254BB4,
	0x601D33C0, 0x609A6059, 0x60DD4DBB, 0x46256118, 0x6199615D,
	0x4DB961DA, 0x6258621D, 0x629D4625, 0x631A62D9, 0x635D4DB6,
	0x46256398, 0x4BB563DD, 0x605A6019, 0x609D4DB4, 0x462060D8,
	0x61596118, 0x20BD619A, 0x61D804C0, 0x621848B0, 0x6299625C,
	0x48AF62DA, 0x63084619, 0x634848AC, 0x63884620, 0x63C8488E,
	0x461049A7, 0x60083140, 0x604848A9, 0x608848A6, 0x60C84620,
	0x61084888, 0x61484610, 0x618848A5, 0x61C848A1, 0x62084620,
	0x62484883, 0x62884610, 0x62C848A1, 0x6308489C, 0x63484620,
	0x6388487E, 0x63C84610, 0x489D4996, 0x60083180, 0x60484896,
	0x60884620, 0x60C84878, 0x61084610, 0x61484898, 0x61884891,
	0x61C84620, 0x62084873, 0x62484610, 0x62884894, 0x62C8488C,
	0x63084620, 0x6348486E, 0x63884610, 0x63C84890, 0x48874985,
	0x600831C0, 0x60484620, 0x60884868, 0x60C84610, 0x6108488B,
	0x61484881, 0x61884620, 0x61C84863, 0x62084610, 0x62484887,
	0x6288487C, 0x62C84620, 0x6308485E, 0x63484610, 0x63884883,
	0x63C84877, 0x46204982, 0x48596008, 0x46106048, 0x48806088,
	0x487260C8, 0x46206108, 0x48546148, 0x46106188, 0x200361C8,
	0x0400497B, 0x487B62C8, 0x210269C0, 0x49794388, 0x206161C8,
	0x61C801C0, 0x48774978, 0x48786208, 0x48786248, 0x48786288,
	0x487862C8, 0x48786308, 0x48786348, 0x48786388, 0x497063C8,
	0x31404877, 0x48776008, 0x49786048, 0x60484876, 0x48774969,
	0x48786148, 0x60014976, 0x48772155, 0x61010209, 0x48764964,
	0x49746108, 0x61484875, 0x496E20FF, 0x31403041, 0x48736048,
	0x20806038, 0x49726088, 0x49696108, 0x61084871, 0x496F20FF,
	0x314030A1, 0x48706388, 0x6001496E, 0x20004963, 0x60C839C0,
	0x49606108, 0x31CF486B, 0x60013080, 0x486A4969, 0x60483180,
	0x60884869, 0x49694866, 0x60C13080, 0x6880485D, 0x03C92101,
	0x495B4308, 0x49566088, 0x39C02001, 0x20FF6008, 0x608830F9,
	0x4A614951, 0x61111C89, 0x495F460A, 0x232960CA, 0x02DB494E,
	0x604B39C0, 0x4C5C4D5D, 0x495D602C, 0x608A2200, 0x36404E5B,
	0x22CF6032, 0x02124F4B, 0x4A59613A, 0x2709617A, 0x02BF4A48,
	0x61173240, 0x4A494F56, 0x4F4C603A, 0x603A4A4A, 0x4F4A4A3E,
	0x378032CF, 0x4A49603A, 0xE0A1607A, 0x6A0391EF, 0x0F600113,
	0x05C6C4EC, 0x40022C00, 0x0000C890, 0x03600513, 0x05C93B14,
	0x05CA7627, 0x05CBB13B, 0x05CCEC4F, 0x05CE2762, 0x05CF6276,
	0x05D09D8A, 0x05D1D89E, 0x05D313B1, 0x05D44EC5, 0x05D589D9,
	0x40022D00, 0x05D6C4EC, 0x05D93B14, 0x05DA7627, 0x05DBB13B,
	0x05DCEC4F, 0x05DE2762, 0x05DF6276, 0x05E09D8A, 0x05E1D89E,
	0x05E313B1, 0x05E44EC5, 0x05E589D9, 0x40022E00, 0x05E6C4EC,
	0x0F141A07, 0x05E93B14, 0x05EA7627, 0x05EBB13B, 0x05ECEC4F,
	0x05EE2762, 0x05EF6276, 0x05F09D8A, 0x05F1D89E, 0x05F313B1,
	0x05F44EC5, 0x05F589D9, 0x40022F00, 0x05F6C4EC, 0x40041A80,
	0x40020000, 0x03020100, 0x40030000, 0x07060504, 0x0B0A0908,
	0x0F0E0D0C, 0x13121110, 0x17161514, 0x1B1A1918, 0x1F1E1D1C,
	0x23222120, 0x27262524, 0x00010001, 0x400250C0, 0x6A0091FF,
	0x7F60010F, 0x4000F400, 0x40020800, 0x0F141607, 0x0010108E,
	0x08600140, 0x40025240, 0x00020020, 0xC30041A0, 0x40041800,
	0x00000A1E, 0x1E1E0101, 0x00001111, 0x40024A00, 0x000A1FFF,
	0x40020180, 0x40024000, 0x0014148E, 0x40040080, 0x60BA4A53,
	0x60FA4A53, 0x4A534F54, 0x4A54607A, 0x4A54603A, 0x4F5160BA,
	0x60BA3740, 0x22014F52, 0x4F53603A, 0x613A4A51, 0x4F4F60FA,
	0x37804A51, 0x62FA63FA, 0x62BA627A, 0x321A4A4E, 0x4F4F637A,
	0x62BA4A4D, 0x4A4E4F48, 0x613A37C0, 0x4F4D22FF, 0x607A3281,
	0x60BA2208, 0x4F4822FF, 0x3740326D, 0x2210603A, 0x4F40613A,
	0x607B60B8, 0x2000602C, 0x60306088, 0x4B444845, 0x4B456143,
	0x4B456183, 0x4B4561C3, 0x493C618B, 0x620131F3, 0x62412100,
	0x2001493E, 0x61483980, 0x212D4840, 0x4C406081, 0x04956B20,
	0x432843A8, 0x6B206320, 0x438803D1, 0x63204308, 0x493A2021,
	0x31400140, 0x6B206048, 0x03092103, 0x63204388, 0x01516B20,
	0x63204388, 0x10496B20, 0x63204388, 0x21806B20, 0x43084388,
	0x6B206320, 0x43882160, 0x6B206320, 0x63204390, 0x08406B20,
	0x63200040, 0x6B60492A, 0x04000C00, 0x63604308, 0x211F6B60,
	0x43880409, 0x43080351, 0x6B206360, 0x43B0010E, 0x63204330,
	0xF854F000, 0xF858F000, 0xF85CF000, 0x43B06B20, 0x6B206320,
	0x43881129, 0x63204308, 0x43A86B20, 0x481A6320, 0x47806800,
	0x21004819, 0xB00B6081, 0x0000BDF0, 0x1E1E0101, 0x00001111,
	0x8228EE03, 0x40020800, 0x00002252, 0x00000EEA, 0x40025000,
	0x00010003, 0x40024A00, 0x00010208, 0x0000022F, 0x40025200,
	0x00020002, 0x40025100, 0xCDDCF0FF, 0x40041900, 0x849DB9CD,
	0x0000567E, 0x00001D5A, 0x40020000, 0x40040040, 0x00000AF2,
	0x100008F8, 0x4000F000, 0x4801B403, 0xBD019001, 0x0000053F,
	0x4801B403, 0xBD019001, 0x00017D1D, 0x4801B403, 0xBD019001,
	0x00016629, 0x4801B403, 0xBD019001, 0x000164BD, 0x4801B403,
0xBD019001, 0x00016E95};


static void fw_patch_download_a3(uint32_t* patch, uint32_t patch_size/*, void* plf_wr_apis*/)
{
	volatile uint32_t i=0, remaining=0;
	volatile uint32_t fp_val;

	remaining = patch_size;
	i=0;
	while(remaining > 128)
	{
		dbg_wr_mem_req_handler32(0x10008000+i*4, &patch[i], 128);
		i+=32;
		remaining -= 128;
	}
	dbg_wr_mem_req_handler32(0x10008000+i*4, &patch[i], (uint8_t)(remaining&0x000000FF));
		
	fp_val = 0x10008001;
	dbg_wr_mem_req_handler32(0x10000004, (uint32_t *)&fp_val, 4);
	fp_val = 0x10008017;
	dbg_wr_mem_req_handler32(0x10000928, (uint32_t *)&fp_val, 4);
	//fp_val = 0x10008039;
//	dbg_wr_mem_req_handler32(0x10000920, (uint32_t *)&fp_val, 4);
	fp_val = 0x5fa0004;
	dbg_wr_mem_req_handler32_reset(0xe000ed0c, (uint32_t *)&fp_val, 4);
	
	#ifndef WIN32
//		for(i=0; i<10000; i++)
	//		fp_val++;
	#else  
	//	boot_delay();
	#endif
}

#endif

at_ble_status_t at_ble_init(void* args)
{
	at_ble_status_t  status;
#ifdef SAMB11
	plf_drv_status 	 plf_status = STATUS_FAILURE;
	plf_status = platform_driver_init();
	if((plf_status != STATUS_SUCCESS) && (plf_status != STATUS_ALREADY_INITIALIZED)) {
		status = AT_BLE_FAILURE;
	}
	else {
		platform_register_ble_msg_handler(rx_callback);
		status = AT_BLE_SUCCESS;
	}
	memset(&device,0,sizeof(device));
#else
	at_ble_events_t event;
	uint8_t params[8];
	status = platform_init(args);
	
	event_init();
#endif
	if(status == AT_BLE_SUCCESS)
	{
	#ifdef SAMB11
		event_init();
	#else
		uint32_t u32chip_id;
		while(at_ble_event_get(&event, params, -1) == AT_BLE_SUCCESS)
		{
			if(event == AT_BLE_DEVICE_READY)
				break;
		}

		at_ble_chip_id_get(&u32chip_id);
#ifndef __WINC3000__
		if(u32chip_id == AT_BLE_CHIP_ID_A4)
			fw_patch_download((uint32_t*)fw_patch, sizeof(fw_patch));
		else if(u32chip_id == AT_BLE_CHIP_ID_A3)
		{
			fw_patch_download_a3((uint32_t*)fw_patch_a3, sizeof(fw_patch_a3));
		}
#endif

		while(at_ble_event_get(&event, params, -1) == AT_BLE_SUCCESS)
		{
			if(event == AT_BLE_DEVICE_READY)
				break;
		}
	#endif	//SAMB11
		if(gapm_reset_req_handler() != ATT_ERR_NO_ERROR)
		{
			status = AT_BLE_FAILURE;
		}
	}

	// init device info
	if(status == AT_BLE_SUCCESS)
	{
		uint8_t loopCntr;
		device.srLen = 0;
		device.advLen = 0;
		device.role = ROLE_SLAVE;
		device.at_addr_set = false;
		device.privacy_flags = 0;
		device.addr_auto_gen = false;
		device.conn_handle = 0xFFFF;
		device.appearance = 0;
		device.spcp_param.con_intv_max = APP_CON_INTV_MIN;
		device.spcp_param.con_intv_min = APP_CON_INTV_MAX;
		device.spcp_param.con_latency = APP_CON_LATENCY;		
		device.spcp_param.superv_to = APP_SUPERV_TO;
		device.dev_name_write_perm = GAPM_WRITE_DISABLE;
		device.renew_dur = GAP_TMR_PRIV_ADDR_INT;
		at_ble_device_name_set((uint8_t *)GAP_device_name,sizeof(GAP_device_name));
		// TODO : used loopCntr value to avoid using rand() with samd21 applications
		for(loopCntr=0; loopCntr<AT_BLE_MAX_KEY_LEN; loopCntr++)
		{
			device.irk.key[loopCntr] = loopCntr;
		}
	}
	return status;
}
at_ble_status_t at_ble_set_privacy_key(at_ble_gap_irk_t* irk , uint16_t interval)
{
	if(interval == 0)
	{
		return AT_BLE_INVALID_PARAM;
	}
	else
	{
		device.renew_dur = interval;
	}
	if(irk != NULL)
	{
		memcpy(device.irk.key ,irk->irk , AT_BLE_MAX_KEY_LEN);
	}
	return AT_BLE_SUCCESS;
	

}

at_ble_status_t at_ble_set_gap_deviceinfo(at_ble_gap_deviceinfo_t*  gap_deviceinfo )
{
	if((gap_deviceinfo == NULL) || ((gap_deviceinfo->dev_name_perm) >AT_BLE_WRITE_AUTH))
	{
		return AT_BLE_INVALID_PARAM;
	}
	else
	{
		memcpy(&(device.spcp_param),&(gap_deviceinfo->spcp_param), sizeof(at_ble_spcp_t));
		device.appearance = gap_deviceinfo->appearance ;

		switch(gap_deviceinfo->dev_name_perm)
		{
		case AT_BLE_WRITE_DISABLE:
				device.dev_name_write_perm = GAPM_WRITE_DISABLE;
			break;
		case AT_BLE_WRITE_ENABLE:
			device.dev_name_write_perm = GAPM_WRITE_ENABLE;
			break;
		case AT_BLE_WRITE_UNAUTH:
			device.dev_name_write_perm = GAPM_WRITE_UNAUTH;
			break;
		case AT_BLE_WRITE_AUTH:
			device.dev_name_write_perm = GAPM_WRITE_AUTH;
			break;
		}
	}
	return AT_BLE_SUCCESS;
}
	
at_ble_status_t at_ble_device_name_set(uint8_t* dev_name, uint8_t len)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	do
	{
		if((dev_name == NULL) ||(len == 0))
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}
		
		if(gapm_set_dev_name_handler (len,dev_name) != ATT_ERR_NO_ERROR)
		{
			status = AT_BLE_FAILURE;
		}
	}while(0);

	return status;
}


at_ble_status_t at_ble_addr_set(at_ble_addr_t* address)
{
	uint8_t u8Status;
	at_ble_status_t status = AT_BLE_SUCCESS;

	do
	{
		if((address->addr == NULL) || 
			(address->type >AT_BLE_ADDRESS_RANDOM_PRIVATE_NON_RESOLVABLE))
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}
		if(address->type == AT_BLE_ADDRESS_PUBLIC)
		{
			u8Status = dbg_le_set_bd_addr_req_handler(address->addr);

			if(u8Status!=AT_BLE_SUCCESS)
			{
				status = AT_BLE_FAILURE;
				break;
			}
			memcpy(device.at_dev_addr.addr, address->addr ,AT_BLE_ADDR_LEN);
		}
		else if (address->type == AT_BLE_ADDRESS_RANDOM_STATIC)
		{
			if(address->addr != NULL)
			{
				memcpy(device.at_dev_addr.addr, address->addr ,AT_BLE_ADDR_LEN);
			}
			else
			{
				device.addr_auto_gen = true;
			}
		}
		else if ((address->type == AT_BLE_ADDRESS_RANDOM_PRIVATE_RESOLVABLE)
			||(address->type == AT_BLE_ADDRESS_RANDOM_PRIVATE_NON_RESOLVABLE))
		{
			device.privacy_flags = 1;
		}
		
		device.at_addr_set = true;
		device.at_dev_addr.type = address->type;
	}while(0);
	return status;
}

at_ble_status_t at_ble_chip_id_get(uint32_t* pu32chip_id)
{
	if(pu32chip_id != NULL)
	{
		*pu32chip_id = 0;
		dbg_rd_mem_req_handler(0x4000B000,(uint8_t *)pu32chip_id,4);
		(*pu32chip_id)&=0xFFFFFF;
		return AT_BLE_SUCCESS;
	}
	else
	{
		return AT_BLE_INVALID_PARAM;
	}
}
at_ble_status_t at_ble_addr_get(at_ble_addr_t* address)
{
	uint8_t addr[AT_BLE_ADDR_LEN+1];
	uint32_t chip_id = 0;
	uint32_t gap_dev_addr = 0;

	if(address == NULL)
	{
		return AT_BLE_INVALID_PARAM;
	}

	dbg_rd_mem_req_handler(0x4000B000,(uint8_t *)&chip_id,4);

	chip_id&=0xFFFFFF;
	switch(chip_id)
	{
		case AT_BLE_CHIP_ID_A0:
			gap_dev_addr = 0x10000E26;
		break;
		case AT_BLE_CHIP_ID_A2:
			gap_dev_addr = 0x10001096;
		break;
		case AT_BLE_CHIP_ID_A3:
			gap_dev_addr = 0x10001156;
		break;
		case AT_BLE_CHIP_ID_A4:
			gap_dev_addr = 0x1000085A;
		break;
	}

	dbg_rd_mem_req_handler(gap_dev_addr, addr, AT_BLE_ADDR_LEN);
	memcpy(address->addr, addr, 6);
	address->type = AT_BLE_ADDRESS_PUBLIC;

	return AT_BLE_SUCCESS;
}

at_ble_status_t at_ble_adv_data_set( uint8_t const *const adv_data,
	uint8_t adv_data_len,uint8_t const *const scan_resp_data,
	uint8_t scan_response_data_len)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	
	do
	{
		if((adv_data== NULL) && (scan_resp_data == NULL))
		{
			status = AT_BLE_FAILURE;  
			break;
		}
		if((adv_data_len > AT_BLE_ADV_MAX_SIZE) || 
			(scan_response_data_len > AT_BLE_ADV_MAX_SIZE))
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}

	    if((adv_data != NULL) && (adv_data_len == 0) )
	    {
	       	// Clear advertising data
			memset(device.ADVData,0, AT_BLE_ADV_MAX_SIZE);
			device.advLen =  0;
	    }
		else if((adv_data != NULL) && (adv_data_len > 0))
		{
			// To do add advertising data check
			memcpy(device.ADVData,adv_data, adv_data_len);
			device.advLen =  adv_data_len;
		}

		if(scan_resp_data != NULL && scan_response_data_len == 0 )
	    {
	       	// Clear scan response data
			memset(device.SrData,0, AT_BLE_ADV_MAX_SIZE);
			device.srLen = 0;
	    }
		else if((scan_resp_data != NULL) && (scan_response_data_len > 0))
		{
			// To do add scan response data check
		    memcpy(device.SrData, scan_resp_data,scan_response_data_len);
			device.srLen = scan_response_data_len;
		}
	}while(0);
	return status;
}

at_ble_status_t at_ble_adv_start(at_ble_adv_type_t type,at_ble_adv_mode_t mode,
				at_ble_addr_t* peer_addr,at_ble_filter_type_t filtered, 
				uint16_t interval, uint16_t timeout, bool disable_randomness)
{
	uint8_t u8Status,adv_type,gatt_dev_addr = 0 , peer_addr_type = 0;
	at_ble_addr_t local_addr;
	uint8_t scan_rsp_len = device.srLen;

	at_ble_status_t status = AT_BLE_SUCCESS;

	// To do add timeout value for GAP
	do
	{
		if(((type != AT_BLE_ADV_TYPE_DIRECTED) && 
		   (device.at_dev_addr.type == AT_BLE_ADDRESS_RANDOM_PRIVATE_NON_RESOLVABLE))
		   ||(((type == AT_BLE_ADV_TYPE_DIRECTED) && 
		   (device.at_dev_addr.type == AT_BLE_ADDRESS_RANDOM_PRIVATE_RESOLVABLE))))
		{
			status = AT_BLE_PRIVACY_CFG_PB;
			break;
		}

		//If the advertising event type is either a discoverable undirected
		//event type or a non-connectable undirected event type, the advInterval shall
		//not be less than 100 ms. If the advertising event type is a connectable undirected
		//event type, the advInterval can be 20 ms or greater.
		if(((type == AT_BLE_ADV_TYPE_DIRECTED)&&(timeout != 0))
		||(type > AT_BLE_ADV_TYPE_NONCONN_UNDIRECTED)
		||(interval > AT_BLE_ADV_INTERVAL_MAX)
		||((type == AT_BLE_ADV_TYPE_UNDIRECTED)&&(interval < AT_BLE_ADV_INTERVAL_MIN)) 
		||((interval < AT_BLE_ADV_NONCON_INTERVAL_MIN) && 
		((type >= AT_BLE_ADV_TYPE_SCANNABLE_UNDIRECTED))) )
		{
			 status = AT_BLE_INVALID_PARAM;
			 break;
		};

		if((type == AT_BLE_ADV_TYPE_DIRECTED)&&
		(!(peer_addr->addr[0] || peer_addr->addr[1] || peer_addr->addr[2] 
		|| peer_addr->addr[3]|| peer_addr->addr[4] || peer_addr->addr[5])))
		{
			 status = AT_BLE_INVALID_PARAM;
			 break;
		}
		
		if((AT_BLE_ADV_TYPE_UNDIRECTED == type) && (AT_BLE_ADV_BROADCASTER_MODE == mode))
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}
		
		status = at_ble_addr_get(&local_addr);
		if(status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}
		// To do check privacy setting and IRK key
		u8Status = gapm_set_dev_config_cmd_handler(GAP_PERIPHERAL_SLV,device.irk.key, 
				device.appearance, GAPM_WRITE_DISABLE, device.dev_name_write_perm, APP_MAX_MTU,
				device.spcp_param.con_intv_min, device.spcp_param.con_intv_max, device.spcp_param.con_latency, 
				device.spcp_param.superv_to, device.privacy_flags);
	
		if(u8Status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}
		switch(type)
		{
			default:
			case  AT_BLE_ADV_TYPE_UNDIRECTED :
				adv_type = GAPM_ADV_UNDIRECT;
				break;
			case  AT_BLE_ADV_TYPE_DIRECTED:     
				adv_type = GAPM_ADV_DIRECT;
				break;
			/* differentiate between them by using scan response length*/
			case AT_BLE_ADV_TYPE_NONCONN_UNDIRECTED:
				scan_rsp_len = 0;
			case AT_BLE_ADV_TYPE_SCANNABLE_UNDIRECTED:     
				adv_type = GAPM_ADV_NON_CONN;
				break;
		}

		/*Own BD address source of the device */
		switch(local_addr.type)
		{
		case AT_BLE_ADDRESS_PUBLIC:
			gatt_dev_addr = GAPM_PUBLIC_ADDR;
			break;
		case AT_BLE_ADDRESS_RANDOM_STATIC:
			if(device.addr_auto_gen == true)
			{
				gatt_dev_addr = GAPM_PROVIDED_RND_ADDR;
			}
			else
			{
				gatt_dev_addr = GAPM_GEN_STATIC_RND_ADDR;
			}
			break;
		case AT_BLE_ADDRESS_RANDOM_PRIVATE_RESOLVABLE:
			gatt_dev_addr = GAPM_GEN_RSLV_ADDR;
			break;
		case AT_BLE_ADDRESS_RANDOM_PRIVATE_NON_RESOLVABLE:
			gatt_dev_addr = GAPM_PROVIDED_RECON_ADDR;
			break;
		}
		if(peer_addr != NULL)
		{
			if(peer_addr->type != AT_BLE_ADDRESS_PUBLIC)
			{
				peer_addr_type = 1;
			}
			else
			{
				peer_addr_type = 0;
			}
		}
		gapm_start_adv_cmd_handler(adv_type, gatt_dev_addr,
			device.renew_dur, local_addr.addr,peer_addr_type,(peer_addr==NULL ? NULL : peer_addr->addr),
			interval, interval, 7, mode, filtered,
			device.advLen, device.ADVData, scan_rsp_len, device.SrData);
		
	}while(0);
	return status;
}

at_ble_status_t at_ble_adv_stop(void)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	
	if(gapm_cancel_cmd_handler())
	{
		status = AT_BLE_FAILURE; 
	}
	return status;
}

at_ble_status_t at_ble_adv_set_tx_power(int8_t power)
{
	// To do check ble max connection number
	at_ble_status_t status = at_ble_tx_power_set(8,power);
	return status;
}
at_ble_status_t at_ble_scan_start(uint16_t interval,uint16_t window,uint16_t timeout,
	at_ble_scan_type_t type ,at_ble_scan_mode_t mode, bool filter_whitelist, 
	bool filter_dublicates)
{
	uint8_t scan_type,u8Status;
	uint8_t gatt_dev_addr = 0;
	at_ble_addr_t local_addr;
	at_ble_status_t status = AT_BLE_SUCCESS;

	// To do support scan timeout
	do
	{
	    // if the scanning window is smaller or equal to the scanning interval
		if ((mode > AT_BLE_SCAN_OBSERVER_MODE)
		||(window > interval)
		||(type > AT_BLE_SCAN_ACTIVE)
		||(window > AT_BLE_SCAN_WINDOW_MAX)
		||(window < AT_BLE_SCAN_WINDOW_MIN)
		||(interval > AT_BLE_SCAN_INTERVAL_MAX)
		||(interval < AT_BLE_SCAN_INTERVAL_MIN))
		{
			 status = AT_BLE_INVALID_PARAM;
			 break;
		};
		
		status = at_ble_addr_get(&local_addr);
		if(status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}
		u8Status = gapm_set_dev_config_cmd_handler(GAP_CENTRAL_MST, device.irk.key,device.appearance,
			GAPM_WRITE_DISABLE, device.dev_name_write_perm, APP_MAX_MTU, 0, 0, 0, 0, 0);

		if(u8Status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}
		
		if(type == AT_BLE_SCAN_PASSIVE)
		{
			scan_type = GAPM_SCAN_PASSIVE; 
		}
		else
		{
			scan_type = GAPM_SCAN_ACTIVE;
		}

		/*Own BD address source of the device */
		switch(local_addr.type)
		{
		case AT_BLE_ADDRESS_PUBLIC:
			gatt_dev_addr = GAPM_PUBLIC_ADDR;
			break;
		case AT_BLE_ADDRESS_RANDOM_STATIC:
			if(device.addr_auto_gen == true)
			{
				gatt_dev_addr = GAPM_PROVIDED_RND_ADDR;
			}
			else
			{
				gatt_dev_addr = GAPM_GEN_STATIC_RND_ADDR;
			}
			break;
		case AT_BLE_ADDRESS_RANDOM_PRIVATE_RESOLVABLE:
			gatt_dev_addr = GAPM_GEN_RSLV_ADDR;
			break;
		case AT_BLE_ADDRESS_RANDOM_PRIVATE_NON_RESOLVABLE:
			gatt_dev_addr = GAPM_GEN_NON_RSLV_ADDR;
			break;
		}

		gapm_start_scan_cmd_handler(scan_type, gatt_dev_addr, 
			device.renew_dur,
			local_addr.addr, interval, window, mode, 
			filter_whitelist, filter_dublicates);

	}while(0);
	return status;
}

at_ble_status_t at_ble_scan_stop(void)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	
	if(gapm_cancel_cmd_handler())
	{
		status = AT_BLE_FAILURE; 
	}
	return status;
}

at_ble_status_t at_ble_connect(at_ble_addr_t peers[], uint8_t peer_count, 
	uint16_t scan_interval, uint16_t scan_window, at_ble_connection_params_t* connection_params)
{

	at_ble_status_t status = AT_BLE_SUCCESS;
	at_ble_addr_t local_addr;
	uint8_t gatt_dev_addr = 0;
	do
	{
		/* check for the range validity of the values */
		if ( (connection_params->con_intv_max < AT_CNX_INTERVAL_MIN || 
		connection_params->con_intv_max > AT_CNX_INTERVAL_MAX) ||
		(connection_params->con_intv_min < AT_CNX_INTERVAL_MIN ||
		connection_params->con_intv_min > AT_CNX_INTERVAL_MAX) ||
		(connection_params->superv_to  < AT_CNX_SUP_TO_MIN   || 
		connection_params->superv_to  > AT_CNX_SUP_TO_MAX)   ||
		(connection_params->con_latency  > AT_CNX_LATENCY_MAX) )
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}

		device.role = ROLE_MASTER;

		status = at_ble_addr_get(&local_addr);
		if(status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}
		status = gapm_set_dev_config_cmd_handler(GAP_CENTRAL_MST,device.irk.key,device.appearance,
		GAPM_WRITE_DISABLE, device.dev_name_write_perm, APP_MAX_MTU, 0, 0, 0, 0, 0);

		/*if(status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}*/

		/*Own BD address source of the device */
		switch(local_addr.type)
		{
		case AT_BLE_ADDRESS_PUBLIC:
			gatt_dev_addr = GAPM_PUBLIC_ADDR;
			break;
		case AT_BLE_ADDRESS_RANDOM_STATIC:
			if(device.addr_auto_gen == true)
			{
				gatt_dev_addr = GAPM_PROVIDED_RND_ADDR;
			}
			else
			{
				gatt_dev_addr = GAPM_GEN_STATIC_RND_ADDR;
			}
			break;
		case AT_BLE_ADDRESS_RANDOM_PRIVATE_RESOLVABLE:
			gatt_dev_addr = GAPM_GEN_RSLV_ADDR;
			break;
		case AT_BLE_ADDRESS_RANDOM_PRIVATE_NON_RESOLVABLE:
			gatt_dev_addr = GAPM_GEN_NON_RSLV_ADDR;
			break;
		}

		gapm_start_connection_cmd_handler(GAPM_CONNECTION_AUTO,gatt_dev_addr, 
			device.renew_dur,local_addr.addr , scan_interval, scan_window,
			connection_params->con_intv_min, connection_params->con_intv_max,
			connection_params->con_latency,
			connection_params->superv_to,
			connection_params->ce_len_min,
			connection_params->ce_len_max,
			peer_count, peers);

	}while(0);
	return status;
}

at_ble_status_t at_ble_connect_cancel(void)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	
	if(gapm_cancel_cmd_handler())
	{
		status = AT_BLE_FAILURE; 
	}
	return status;
}

at_ble_status_t at_ble_sec_info_set(at_ble_handle_t handle, at_ble_signature_info_t signature_info, at_ble_auth_t auth, at_ble_author_t author)
{
	gapc_connection_cfm_handler(signature_info.local_csrk.key, signature_info.lsign_counter,
		signature_info.peer_csrk.key, signature_info.peer_sign_counter, auth,
					author, handle);
	return AT_BLE_SUCCESS;
}

at_ble_status_t at_ble_whitelist_add(at_ble_addr_t* address)
{
	at_ble_status_t status= AT_BLE_SUCCESS;
	if(address->addr == NULL)
	{
		return AT_BLE_FAILURE;
	}

	status = gapm_white_list_mgm_cmd(GAPM_ADD_DEV_IN_WLIST, 
		address->type, address->addr);

	return status;
}

at_ble_status_t at_ble_whitelist_remove(at_ble_addr_t* address)
{
	at_ble_status_t status= AT_BLE_SUCCESS;
	if(address->addr == NULL)
	{
		return AT_BLE_FAILURE;
	}

	status = gapm_white_list_mgm_cmd(GAPM_RMV_DEV_FRM_WLIST, 
		address->type, address->addr);

	return status;
}

at_ble_status_t at_ble_whitelist_clear(void)
{
	at_ble_status_t status= AT_BLE_SUCCESS;
	status= gapm_white_list_mgm_cmd(GAPM_CLEAR_WLIST, 
		0, NULL);

	return status;
}

at_ble_status_t at_ble_disconnect(at_ble_handle_t handle, at_ble_disconnect_reason_t reason)
{
	uint8_t gapc_reason ;
	switch(reason)
	{
		case AT_BLE_TERMINATED_BY_USER:
			gapc_reason = 0x13;
			break;
		case AT_BLE_UNACCEPTABLE_INTERVAL:
			gapc_reason = 0x3b;
			break;
		default:
			gapc_reason = 0x1F;
	}
	gapc_disconnect_cmd_handler(gapc_reason, handle);
	device.conn_handle = 0xFFFF;
	
	return AT_BLE_SUCCESS;
}


at_ble_status_t at_ble_connection_param_update(at_ble_handle_t handle, 
	at_ble_connection_params_t* connection_params)
{
	/* check for the range validity of the values */
	if ( (connection_params->con_intv_max < AT_CNX_INTERVAL_MIN || 
	connection_params->con_intv_max > AT_CNX_INTERVAL_MAX) ||
	(connection_params->con_intv_min < AT_CNX_INTERVAL_MIN ||
	connection_params->con_intv_min > AT_CNX_INTERVAL_MAX) ||
	(connection_params->superv_to  < AT_CNX_SUP_TO_MIN   || 
	connection_params->superv_to  > AT_CNX_SUP_TO_MAX)   ||
	(connection_params->con_latency  > AT_CNX_LATENCY_MAX) )
	{
		return AT_BLE_INVALID_PARAM;
	}

	gapc_param_update_cmd_handler(handle,
		connection_params->con_intv_min, connection_params->con_intv_max,
		connection_params->con_latency, connection_params->superv_to, 
		connection_params->ce_len_min, connection_params->ce_len_max);

	return AT_BLE_SUCCESS;
}

// To do check parameters
void at_ble_conn_update_reply(at_ble_handle_t conn_handle , 
				at_ble_connection_params_t* connection_params)
{
	gapc_param_update_cfm_handler(conn_handle, 
		connection_params->ce_len_min, connection_params->ce_len_max);
}

at_ble_status_t at_ble_tx_power_set(at_ble_handle_t conn_handle, float power)
{
	uint32_t level;
	if(power<=(-16.5))
		level=1;
	else if(power<=(-11))
		level=2;
	else if(power<=(-7.9))
		level=3;
	else if(power<=(-5.9))
		level=4;
	else if(power<=(-4.3))
		level=5;
	else if(power<=(-3.2))
		level=6;
	else if(power<=(-2.4))
		level=7;
	else if(power<=(-1.7))
		level=8;
	else if(power<=(-1.2))
		level=9;
	else if(power<=(-0.7))
		level=10;
	else if(power<=(0.1))
		level=12;
	else if(power<=(0.6))
		level=14;
	else if(power<=(1))
		level=16;
	else if(power<=(1.4))
		level=18;
	else if(power<=(1.6))
		level=20;
	else if(power<=(1.8))
		level=22;
	else if(power<=(2))
		level=24;
	else if(power<=(2.1))
		level=26;
	else if(power<=(2.3))
		level=28;
	else if(power<=(2.4))
		level=30;
	else if(power<=(2.6))
		level=34;
	else if(power<=(2.7))
		level=38;
	else if(power<=(2.8))
		level=42;
	else if(power<=(3))
		level=50;
	else
		level=63;
	/// Power table
//	static const int8_t RF_RPL_TX_PW_CONV_TBL[RPL_PWR_TBL_SIZE] 
//			= {-23,-20,-17,-14,-11,-8,-5,-2};


/*	for(level = RPL_POWER_MIN; level <= RPL_POWER_MAX; level++)
	{
		if(RF_RPL_TX_PW_CONV_TBL[level] >= power)
			break;
	}

	if(level > RPL_POWER_MAX)
	{
		level = RPL_POWER_MAX;
	}
*/
	if(dbg_wr_mem_req_handler32(0x4002084c, (uint32_t*)&level, 1) != AT_BLE_SUCCESS)
	{
		return AT_BLE_FAILURE;
	}
	else
	{
		return AT_BLE_SUCCESS;
	}
}

float at_ble_tx_power_get(at_ble_handle_t conn_handle)
{
	uint32_t level=0;
	double power;
	dbg_rd_mem_req_handler32(0x4002084c, (uint8_t*)&level, 4);

	level&=0x3f;
	if(level<=1)
		power=(-16.5);
	else if(level==2)
		power=(-11);
	else if(level==3)
		power=(-7.9);
	else if(level==4)
		power=(-5.9);
	else if(level==5)
		power=(-4.3);
	else if(level==6)
		power=(-3.2);
	else if(level==7)
		power=(-2.4);
	else if(level==8)
		power=(-1.7);
	else if(level==9)
		power=(-1.2);
	else if(level==10)
		power=(-0.7);
	else if(level<=12)
		power=(0.1);
	else if(level<=14)
		power=(0.6);
	else if(level<=16)
		power=(1);
	else if(level<=18)
		power=(1.4);
	else if(level<=20)
		power=(1.6);
	else if(level<=22)
		power=(1.8);
	else if(level<=24)
		power=(2);
	else if(level<=26)
		power=(2.1);
	else if(level<=28)
		power=(2.3);
	else if(level<=30)
		power=(2.4);
	else if(level<=34)
		power=(2.6);
	else if(level<=38)
		power=(2.7);
	else if(level<=42)
		power=(2.8);
	else if(level<=50)
		power=(3);
	else
		power=3.1;

	return (float)power;
}

at_ble_status_t at_ble_random_address_resolve(uint8_t nb_key, at_ble_addr_t* rand_addr, uint8_t* irk_key)
{
	at_ble_status_t status = AT_BLE_SUCCESS;

	do
	{
		if((rand_addr == NULL) || (irk_key == NULL) ||(nb_key == 0)||
			(rand_addr->type != AT_BLE_ADDRESS_RANDOM_PRIVATE_RESOLVABLE ))
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}

		gapm_resolv_addr_cmd_handler(nb_key , rand_addr->addr,irk_key);
	}while(0);
	return status;
}


int8_t at_ble_rx_power_get(at_ble_handle_t conn_handle)
{
	at_ble_events_t event;
	uint8_t params[1];
	uint16_t rssi = 0;

	gapc_get_info_cmd_handler(conn_handle, GAPC_GET_CON_RSSI);

	do
	{
		if (at_ble_event_get(&event, params, -1) == AT_BLE_SUCCESS)
		{
			if (event == AT_BLE_RX_POWER_VALUE)
			{
				gapc_con_rssi_ind* p = (gapc_con_rssi_ind* )params;
				rssi = p->rssi;
			}
		}
	}while(event != AT_BLE_RX_POWER_VALUE);

	if(rssi > 127)
	{
		rssi -= 255;
	}

	return (int8_t)rssi;
}
