/**
 * @file tal_irq_handler.c
 *
 * @brief This file handles the interrupts generated by the transceiver.
 *
 * $Id: tal_irq_handler.c 35124 2013-09-19 11:22:42Z uwalter $
 *
 * @author    Atmel Corporation: http://www.atmel.com
 * @author    Support email: avr@atmel.com
 */
/*
 * Copyright (c) 2012, Atmel Corporation All rights reserved.
 *
 * Licensed under Atmel's Limited License Agreement --> EULA.txt
 */

/* === INCLUDES ============================================================ */

#include <stdint.h>
#include <stdbool.h>
#include <stddef.h>
#include "pal.h"
#include "tal_config.h"
#include "tal_internal.h"
#ifdef CHIP_MODE_TEST
#include "pal_internal.h"
#endif


/* === TYPES =============================================================== */

/* === MACROS ============================================================== */

/* === GLOBALS ============================================================= */

#ifdef CHIP_MODE_TEST
static bool forced_txprep_cmd[2] = { false, false };
static bool forced_ed_measurement[2] = { false, false };
#endif

/* === PROTOTYPES ========================================================== */

/* === IMPLEMENTATION ====================================================== */


/**
 * @brief Transceiver interrupt handler
 *
 * This function handles the transceiver interrupt. It reads all IRQs from the
 * transceivers and stores them to a variable. If a transceiver is currently
 * sleeping, then the IRQs are not handled.
 * The actual processing of the IRQs is triggered from tal_task().
 */
void trx_irq_handler_cb(void)
{
    //debug_text(PSTR("trx_irq_handler_cb()"));
#ifdef CHIP_MODE_TEST
    if (chip_mode == true)
    {
        //debug_text_val(PSTR("chip_mode ="), chip_mode);
    }
#endif

    /* Get all IRQS values */
    uint8_t irqs_array[4];
#ifdef CHIP_MODE_TEST
    if (chip_mode == true)
    {
        /* Read only RF interrupt status */
        pal_trx_read(RG_RF09_IRQS, irqs_array, 2);
    }
    else
#endif
    {
        pal_trx_read(RG_RF09_IRQS, irqs_array, 4);
    }

#ifdef CHIP_MODE_TEST
    if (chip_mode == false)
#endif
    {
        /* Handle BB IRQS */
        for (uint8_t trx_id = 0; trx_id < 2; trx_id++)
        {
            if (tal_state[trx_id] == TAL_SLEEP)
            {
                continue;
            }

            uint8_t irqs = irqs_array[trx_id + 2];

            if (irqs != BB_IRQ_NO_IRQ)
            {
                //debug_text_val(PSTR("INFO: ISR for BB "), trx_id);
                //debug_text_val(PSTR("INFO: IRQ-flag-vector of RG_BBCx_IRQS ="), irqs);

                if (irqs & BB_IRQ_RXEM)
                {
                    //debug_text(PSTR("IRQ - BB_IRQ_RXEM"));
                    irqs &= (uint8_t)(~((uint32_t)BB_IRQ_RXEM)); // avoid Pa091
                }
                if (irqs & BB_IRQ_RXAM)
                {
                    //debug_text(PSTR("IRQ - BB_IRQ_RXAM"));
                    irqs &= (uint8_t)(~((uint32_t)BB_IRQ_RXAM)); // avoid Pa091
                }
                if (irqs & BB_IRQ_AGCR)
                {
                    //debug_text(PSTR("IRQ - BB_IRQ_AGCR"));
                    irqs &= (uint8_t)(~((uint32_t)BB_IRQ_AGCR)); // avoid Pa091
                }
                if (irqs & BB_IRQ_AGCH)
                {
                    //debug_text(PSTR("IRQ - BB_IRQ_AGCH"));
                    irqs &= (uint8_t)(~((uint32_t)BB_IRQ_AGCH)); // avoid Pa091
                }
                if (irqs & BB_IRQ_RXFS)
                {
                    //debug_text(PSTR("IRQ - BB_IRQ_RXFS"));
#ifdef ENABLE_TSTAMP
                    pal_get_current_time(&fs_tstamp[trx_id]);
#endif
                    irqs &= (uint8_t)(~((uint32_t)BB_IRQ_RXFS)); // avoid Pa091
                }
                if (irqs & BB_IRQ_RXFE)
                {
                    //debug_text(PSTR("IRQ - BB_IRQ_RXFE"));
                    pal_get_current_time(&rxe_txe_tstamp[trx_id]);
                }
                if (irqs & BB_IRQ_TXFE)
                {
                    //debug_text(PSTR("IRQ - BB_IRQ_TXFE"));
                    /* used for IFS and for MEASURE_ON_AIR_DURATION */
                    pal_get_current_time(&rxe_txe_tstamp[trx_id]);
                }

                /*
                 * Store remaining flags to global TAL variable and
                 * handle them within tal_task()
                 */
                tal_bb_irqs[trx_id] |= irqs;
            }
        }
    }

    /* Handle RF IRQS */
    for (uint8_t trx_id = 0; trx_id < 2; trx_id++)
    {
        if (tal_state[trx_id] == TAL_SLEEP)
        {
            continue;
        }

        uint8_t irqs = irqs_array[trx_id];

        if (irqs != RF_IRQ_NO_IRQ)
        {
            //debug_text_val(PSTR("INFO: ISR for RF "), trx_id);
            //debug_text_val(PSTR("INFO: IRQ-flag-vector of RG_RFxx_IRQS ="), irqs);

            if (irqs & RF_IRQ_TRXRDY)
            {
                //debug_text(PSTR("IRQ - RF_IRQ_TRXRDY"));
#ifdef CHIP_MODE_TEST
                if (chip_mode && forced_txprep_cmd[trx_id])
                {
                    forced_txprep_cmd[trx_id] = false;
                    //debug_text(PSTR("Forced TxPrep irq handled."));
                    irqs &= ~RF_IRQ_TRXRDY;
                }
#endif
            }
            if (irqs & RF_IRQ_TRXERR)
            {
                //debug_text(PSTR("IRQ - RF_IRQ_TRXERR"));
            }
            if (irqs & RF_IRQ_BATLOW)
            {
                //debug_text(PSTR("IRQ - RF_IRQ_BATLOW"));
            }
            if (irqs & RF_IRQ_WAKEUP)
            {
                //debug_text(PSTR("IRQ - RF_IRQ_WAKEUP"));
            }
            if (irqs & RF_IRQ_IQIFSF)
            {
                //debug_text(PSTR("IRQ - RF_IRQ_IQIFSF"));
            }
            if (irqs & RF_IRQ_EDC)
            {
#ifdef CHIP_MODE_TEST
                if (chip_mode && forced_ed_measurement[trx_id])
                {
                    forced_ed_measurement[trx_id] = false;
                    //debug_text(PSTR("Forced ED measurement irq handled."));
                    irqs &= ~RF_IRQ_EDC;
                }
#endif
                //debug_text(PSTR("IRQ - RF_IRQ_EDC"));
            }
            tal_rf_irqs[trx_id] |= irqs;
        }
    }
}/* trx_irq_handler_cb() */


#ifdef CHIP_MODE_TEST
void bb_irq_handler_cb(void)
{
    //debug_text(PSTR("bb_irq_handler_cb()"));
    //debug_text_val(PSTR("chip_mode ="), chip_mode);

    /* Get all IRQS values */
    uint8_t irqs_array[4];

    if (chip_mode == true)
    {
        /* Read interrupt status */
        irqs_array[0] = bb_reg_read(RG_RF09_IRQS);
        //debug_text_val(PSTR("BB RG_RF09_IRQS ="), irqs_array[0]);
        irqs_array[1] = bb_reg_read(RG_RF24_IRQS);
        //debug_text_val(PSTR("BB RG_RF24_IRQS ="), irqs_array[1]);
        irqs_array[2] = bb_reg_read(RG_BBC0_IRQS);
        //debug_text_val(PSTR("BB RG_BBC0_IRQS ="), irqs_array[2]);
        irqs_array[3] = bb_reg_read(RG_BBC1_IRQS);
        //debug_text_val(PSTR("BB RG_BBC1_IRQS ="), irqs_array[3]);
    }
    else
    {
        /* We should never use bb_irq_handler while not using chip mode */
        //debug_text_finish(PSTR("Unexpected IRQ during chip mode"), DEBUG_ERROR);
        //pal_trx_read(RG_RF09_IRQS, irqs_array, 4);
    }

    /* Handle BB IRQS */
    for (uint8_t trx_id = 0; trx_id < 2; trx_id++)
    {
        if (tal_state[trx_id] == TAL_SLEEP)
        {
            continue;
        }

        uint8_t irqs = irqs_array[trx_id + 2];

        if (irqs != BB_IRQ_NO_IRQ)
        {
            //debug_text_val(PSTR("INFO: ISR for BB "), trx_id);
            //debug_text_val(PSTR("INFO: BB IRQ-flag-vector of RG_BBCx_IRQS ="), irqs);

            if (irqs & BB_IRQ_RXEM)
            {
                //debug_text(PSTR("BB IRQ - RXEM"));
                irqs &= (uint8_t)(~((uint32_t)BB_IRQ_RXEM)); // avoid Pa091
            }
            if (irqs & BB_IRQ_RXAM)
            {
                //debug_text(PSTR("BB IRQ - RXAM"));
                irqs &= (uint8_t)(~((uint32_t)BB_IRQ_RXAM)); // avoid Pa091
            }
            if (irqs & BB_IRQ_AGCR)
            {
                //debug_text(PSTR("BB IRQ - AGCR"));
                irqs &= (uint8_t)(~((uint32_t)BB_IRQ_AGCR)); // avoid Pa091
                uint16_t rf_reg_offset = RF_BASE_ADDR_OFFSET * trx_id;
                /* Release AGC */
                ////debug_text(PSTR("Release AGC"));
                pal_trx_bit_write(rf_reg_offset + SR_RF09_AGCC_FRZC, 0);

            }
            if (irqs & BB_IRQ_AGCH)
            {
                //debug_text(PSTR("BB IRQ - AGCH"));
                irqs &= (uint8_t)(~((uint32_t)BB_IRQ_AGCH)); // avoid Pa091
                /* Hold AGC */
                uint16_t rf_reg_offset = RF_BASE_ADDR_OFFSET * trx_id;
                ////debug_text(PSTR("Hold AGC"));
                pal_trx_bit_write(rf_reg_offset + SR_RF09_AGCC_FRZC, 1);
            }
            if (irqs & BB_IRQ_RXFS)
            {
                //debug_text(PSTR("BB IRQ - RXFS"));
#ifdef ENABLE_TSTAMP
                pal_get_current_time(&fs_tstamp[trx_id]);
#endif
                irqs &= (uint8_t)(~((uint32_t)BB_IRQ_RXFS)); // avoid Pa091
                /* Trigger single ED measurement for incoming frame */
                forced_ed_measurement[trx_id] = true;
                uint16_t rf_reg_offset = RF_BASE_ADDR_OFFSET * trx_id;
                pal_trx_bit_write(rf_reg_offset + SR_RF09_EDC_EDM, RF_EDSINGLE);
            }
            if (irqs & BB_IRQ_RXFE)
            {
                //debug_text(PSTR("BB IRQ - RXFE"));
                pal_get_current_time(&rxe_txe_tstamp[trx_id]);

                //debug_text(PSTR("Switch RF to TxPREP"));
                uint16_t rf_reg_offset = RF_BASE_ADDR_OFFSET * trx_id;
                uint8_t cmd = RF_TXPREP;
                rf_reg_write(rf_reg_offset + RG_RF09_CMD, &cmd);
                /* Handle trxrdy interrupt at radio */
                forced_txprep_cmd[trx_id] = true;
            }
            if (irqs & BB_IRQ_TXFE)
            {
                //debug_text(PSTR("BB IRQ - TXFE"));

                //debug_text(PSTR("Switch RF to TxPREP"));
                uint16_t rf_reg_offset = RF_BASE_ADDR_OFFSET * trx_id;
                uint8_t cmd = RF_TXPREP;
                rf_reg_write(rf_reg_offset + RG_RF09_CMD, &cmd);
                /* Handle trxrdy interrupt at radio */
                forced_txprep_cmd[trx_id] = true;

                //if (tal_state[trx_id] == TAL_TX)
                {
                    /* used for IFS and for MEASURE_ON_AIR_DURATION */
                    pal_get_current_time(&rxe_txe_tstamp[trx_id]);
                }
            }

            /*
             * Store remaining flags to global TAL variable and
             * handle them within tal_task()
             */
            tal_bb_irqs[trx_id] |= irqs;
        }
    }

    /* Handle RF IRQS */
    for (uint8_t trx_id = 0; trx_id < 2; trx_id++)
    {
        if (tal_state[trx_id] == TAL_SLEEP)
        {
            continue;
        }

        uint8_t irqs = irqs_array[trx_id];

        if (irqs != RF_IRQ_NO_IRQ)
        {
            //debug_text_val(PSTR("INFO: ISR for RF "), trx_id);
            //debug_text_val(PSTR("INFO: IRQ-flag-vector of RG_RFxx_IRQS ="), irqs);

            if (irqs & RF_IRQ_TRXRDY)
            {
                //debug_text(PSTR("BB IRQ - RF_IRQ_TRXRDY"));
                irqs &= (uint8_t)(~((uint32_t)RF_IRQ_TRXRDY)); // avoid Pa091
            }
            if (irqs & RF_IRQ_TRXERR)
            {
                //debug_text(PSTR("BB IRQ - RF_IRQ_TRXERR"));
            }
            if (irqs & RF_IRQ_BATLOW)
            {
                //debug_text(PSTR("BB IRQ - RF_IRQ_BATLOW"));
            }
            if (irqs & RF_IRQ_WAKEUP)
            {
                //debug_text(PSTR("BB IRQ - RF_IRQ_WAKEUP"));
                irqs &= (uint8_t)(~((uint32_t)RF_IRQ_WAKEUP)); // avoid Pa091
            }
            if (irqs & RF_IRQ_IQIFSF)
            {
                //debug_text(PSTR("BB IRQ - RF_IRQ_IQIFSF"));
            }
            if (irqs & RF_IRQ_EDC)
            {
                //debug_text(PSTR("BB IRQ - RF_IRQ_EDC"));
            }

            if (irqs != 0)
            {
                //debug_text_finish(PSTR("Unexpected BB IRQS"), DEBUG_ERROR);
            }

            tal_rf_irqs[trx_id] |= irqs;
        }
    }
}/* bb_irq_handler_cb() */
#endif

/* EOF */
