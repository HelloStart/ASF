
#include "at_ble_api.h"

#include "platform.h"
#include "gattc_task.h"
#include "gattm_task.h"
#include "gapm_task.h"
#include "gapc_task.h"
#include "dbg_task.h"

#include "device.h"
#include "event.h"

// Slave preferred Connection interval Min
#define APP_CON_INTV_MIN	8
// Slave preferred Connection interval Max
#define APP_CON_INTV_MAX	10
// Slave preferred Connection latency
#define APP_CON_LATENCY		0
// Slave preferred Link supervision timeout
#define APP_SUPERV_TO		200 // 2s (500*10ms)

#define APP_MAX_MTU			L2C_MIN_LE_MTUSIG
#define APP_FLAGS			0

#define LOCAL_ADDR_TYPE GAPM_PUBLIC_ADDR
#define GAP_device_name "ATMEL-HT"
static uint8_t IRK_KEY[KEY_LEN] = {0xEF, 0xCD, 0xAB, 0x89, 0x67, 0x45, 0x23, 0x01, 0xEF, 0xCD, 0xAB, 0x89, 0x67, 0x45, 0x23, 0x01};
static uint8_t rand_addr[BD_ADDR_LEN]= { 0x00,0x00,0x00,0x00,0x00,0x00};

struct device_info device;

uint32_t fw_patch[] = {
	0xB4FFB500, 0x46494640, 0x465B4652, 0xF3EF4664, 0xB43F8503,
	0x8009F3EF, 0x681A4B04, 0x98066010, 0x9A089907, 0x9C0A9B09,
	0x47709D0B, 0x10000970, 0x49484849, 0x21006141, 0x21056181,
	0x47706101, 0x69804845, 0x4D454770, 0x4F464C45, 0x68204E46,
	0xD4790400, 0x28017830, 0xBF30D001, 0x2000E7F7, 0xF7FF60A8,
	0x68A8FFCD, 0x68A82800, 0x2801D02F, 0x493ED1ED, 0x61080380,
	0xFAE2F001, 0xFFD8F7FF, 0x6800483B, 0x22014780, 0x06D0493A,
	0x483A6008, 0xB6626182, 0xF0012000, 0x2001FAD9, 0xFAD6F001,
	0xF0012002, 0x2003FAD3, 0xFAD0F001, 0xF0012004, 0x2005FACD,
	0xFACAF001, 0x69814830, 0xD4FC00C9, 0x6079492F, 0x07C96941,
	0x492ED021, 0x1C40E021, 0x200F60A8, 0xFAC0F001, 0xF001482B,
	0x481EFAC3, 0x492A6980, 0x1A086809, 0x492903C0, 0xFAC0F001,
	0x680A4928, 0x60081A10, 0x380F6808, 0xFABEF001, 0xFAC2F001,
	0x68014824, 0xD5FC0449, 0x491DE7FE, 0x60B93111, 0x07496941,
	0x4920D40E, 0x210162B9, 0x61210289, 0x01C06980, 0xD5016820,
	0xE0004308, 0x60204388, 0xE007E002, 0x60F84819, 0xFAAAF001,
	0x28017830, 0xE782D0FC, 0xE780BF30, 0x48154916, 0xE76D6048,
	0x00FFFFFF, 0xE000E000, 0x100000D0, 0x40011000, 0x4000B040,
	0x100008C8, 0x40010000, 0x100008E0, 0xE000E100, 0x40004000,
	0x4000B140, 0x22222222, 0x20222222, 0x002700FF, 0x100096D0,
	0x018CBA80, 0x10000914, 0x4000D000, 0x00004231, 0x00002222,
	0x12345679, 0x4000F040, 0x2101B510, 0x07094802, 0xF0016048,
	0xBD10FA73, 0x00018119, 0xF7FFB510, 0x49FEFF3D, 0x49FE6008,
	0x22076B08, 0x63084310, 0xB5F0BD10, 0xB08B4FFB, 0x15BA6879,
	0x60794311, 0x21004AF9, 0x085B6813, 0x6013005B, 0x62424AF7,
	0x62824AF7, 0x61424AF7, 0x22302306, 0x4AF65413, 0x4AF662C2,
	0x4AF66002, 0x4AF66202, 0x4EEC6042, 0x36804AF5, 0x683061C2,
	0x0612227F, 0x065A4390, 0x60304310, 0x22FF6830, 0x43900412,
	0x04522221, 0x60304310, 0x220F6830, 0x43900212, 0x02122207,
	0x60304310, 0x20566832, 0x02120A12, 0x60324302, 0x0048466A,
	0x1C495450, 0x2928B2C9, 0x48E3D3F9, 0x210269C0, 0x49E14308,
	0x49E161C8, 0x60C8200D, 0x684148E0, 0x43112203, 0x68C16041,
	0x43112202, 0x4CDE60C1, 0x602048DC, 0x60624ADD, 0x60A048DD,
	0x60E34BDD, 0x612149DD, 0x61654DDD, 0x61E061A2, 0x62616223,
	0x62A54DDB, 0x632062E2, 0x63A16363, 0x63E54DD9, 0x34404CD1,
	0x60606022, 0x60E160A3, 0x4CD64DCE, 0x612C3540, 0x61A8616A,
	0x622961EB, 0x626C4CD3, 0x62E862AA, 0x6369632B, 0x63AC4CD1,
	0x4CC663EA, 0x60203480, 0x60A16063, 0x4CCE4DC3, 0x60EC3580,
	0x6168612A, 0x61E961AB, 0x0524245D, 0x626A622C, 0x62EB62A8,
	0x4CC86329, 0x63AA636C, 0x4CBA63E8, 0x602334C0, 0x4DB86061,
	0x35C04CC4, 0x60EA60AC, 0x616B6128, 0x4CC261A9, 0x622A61EC,
	0x62AB6268, 0x4CC062E9, 0x636A632C, 0x63EB63A8, 0x60214CBE,
	0x4CBE4DBD, 0x60AA606C, 0x612B60E8, 0x4CBC6169, 0x61EA61AC,
	0x626B6228, 0x4CBA62A9, 0x632A62EC, 0x63AB6368, 0x63E1462C,
	0x4DB74CB3, 0x60253440, 0x60A06062, 0x612160E3, 0x61654DB4,
	0x61E061A2, 0x62616223, 0x62A54DB2, 0x632062E2, 0x63A16363,
	0x63E54DB0, 0x34804CA8, 0x60606022, 0x60E160A3, 0x61254DAD,
	0x61A06162, 0x622161E3, 0x056D252F, 0x62A26265, 0x632362E0,
	0x4DA86361, 0x63E263A5, 0x34C04C9D, 0x60636020, 0x4DA560A1,
	0x612260E5, 0x61A36160, 0x4DA361E1, 0x62626225, 0x62E362A0,
	0x4DA16321, 0x63A26365, 0x4CA063E0, 0x60616023, 0x60A54D9F,
	0x612060E2, 0x61A16163, 0x61E54D9D, 0x62606222, 0x62E162A3,
	0x63254D9B, 0x63A06362, 0x4C9663E3, 0x60213440, 0x60654D98,
	0x60E060A2, 0x61616123, 0x61A54D96, 0x622061E2, 0x62A16263,
	0x62E54D94, 0x63606322, 0x63E163A3, 0x4D924C8B, 0x60253480,
	0x60A06062, 0x612160E3, 0x6161498F, 0x61A14611, 0x622361E0,
	0x6260486B, 0x0500205F, 0x62E162A0, 0x63204866, 0x48676363,
	0x488863A0, 0x460863E0, 0x31C0497D, 0x48616008, 0x608B6048,
	0x60C84861, 0x61084883, 0x61484610, 0x6188485C, 0x485D61CB,
	0x48806208, 0x46106248, 0x48586288, 0x630B62C8, 0x63484858,
	0x6388487C, 0x63C84610, 0x4853497B, 0x604B6008, 0x60884853,
	0x60C84879, 0x61084610, 0x6148484E, 0x484F618B, 0x497761C8,
	0x60084875, 0x604D1ED5, 0x60884875, 0x4A7360CB, 0x61114974,
	0x4C7122B9, 0x616204D2, 0x61E061A5, 0x62616223, 0x62A24A70,
	0x62E2462A, 0x63636320, 0x4A6E63A1, 0x4A6963E2, 0x3240462C,
	0x60506014, 0x60D16093, 0x61144C6A, 0x6154462C, 0x61D36190,
	0x4C686211, 0x462C6254, 0x62D06294, 0x63516313, 0x63944C65,
	0x63D4462C, 0x32804A5C, 0x60536010, 0x4C626091, 0x462C60D4,
	0x61506114, 0x61D16193, 0x62144C5F, 0x6254462C, 0x62D36290,
	0x4C5D6311, 0x462C6354, 0x63D06394, 0x32C04A50, 0x60516013,
	0x60944C59, 0x60D4462C, 0x61536110, 0x4C576191, 0x462C61D4,
	0x62506214, 0x62D16293, 0x63144C54, 0x6354462C, 0x63D36390,
	0x60114A52, 0x60544C52, 0x6094462C, 0x611360D0, 0x24BB6151,
	0x619404E4, 0x61D4462C, 0xE0996210, 0x100096D0, 0x40040000,
	0x4000F400, 0x40041800, 0x00017407, 0x000173F9, 0x0001716F,
	0x100081C1, 0x00017141, 0x0001715B, 0x0001715D, 0x0001712B,
	0x40020000, 0x40020840, 0x4000F000, 0x05C62762, 0x40022800,
	0x0F141A07, 0x6A0291FF, 0x0000C890, 0x0F600613, 0x05C76276,
	0x05C89D8A, 0x05C9D89E, 0x05CB13B1, 0x05CC4EC5, 0x05CD89D9,
	0x05CEC4EC, 0x05D13B14, 0x05D27627, 0x05D3B13B, 0x05D4EC4F,
	0x40022900, 0x05D62762, 0x05D76276, 0x05D89D8A, 0x05D9D89E,
	0x05DB13B1, 0x05DC4EC5, 0x05DD89D9, 0x05DEC4EC, 0x05E13B14,
	0x05E27627, 0x05E3B13B, 0x05E4EC4F, 0x40022A00, 0x05E62762,
	0x05E76276, 0x05E89D8A, 0x05E9D89E, 0x05EB13B1, 0x05EC4EC5,
	0x05ED89D9, 0x05EEC4EC, 0x05F13B14, 0x05F27627, 0x05F3B13B,
	0x05F4EC4F, 0x40022B00, 0x05F62762, 0x05C6C4EC, 0x40022C00,
	0x6A0091D7, 0x03600613, 0x05C93B14, 0x05CA7627, 0x05CBB13B,
	0x05CCEC4F, 0x05CE2762, 0x05CF6276, 0x05D09D8A, 0x05D1D89E,
	0x05D313B1, 0x05D44EC5, 0x05D589D9, 0x40022D00, 0x05D6C4EC,
	0x62916253, 0x62D44CFE, 0x6314462C, 0x63936350, 0x4AFD63D1,
	0x60144CFB, 0x6054462C, 0x60D36090, 0x4CFA6111, 0x462C6154,
	0x61D06194, 0x62516213, 0x62944CF7, 0x62D4462C, 0x63536310,
	0x4CF56391, 0x4AF163D4, 0x3240462C, 0x60506014, 0x60D16093,
	0x61144CF1, 0x6154462C, 0x61D36190, 0x4CEF6211, 0x462C6254,
	0x62D06294, 0x63516313, 0x63944CEC, 0x63D4462C, 0x32804AE4,
	0x60536010, 0x4CE96091, 0x462C60D4, 0x61506114, 0x61D16193,
	0x62144CE6, 0x6254462C, 0x62D36290, 0x4CE46311, 0x462C6354,
	0x63D06394, 0x32C04AD8, 0x60516013, 0x60944CE0, 0x60D4462C,
	0x61536110, 0x21BD6191, 0x61D104C9, 0x62506215, 0x48DB6293,
	0x48DB62D0, 0x63084611, 0x48DA634C, 0x46186388, 0x49D963C8,
	0x600848D5, 0x604848D8, 0x60884620, 0x60C848D4, 0x61084618,
	0x614848D0, 0x618848D4, 0x61C84620, 0x49CF48D0, 0x49CF6201,
	0x62484618, 0x628848CA, 0x62C848CF, 0x63084620, 0x634848C9,
	0x461948C9, 0x49C86381, 0x63C848C4, 0x48CA49C6, 0x60083140,
	0x60484620, 0x608848C2, 0x60C84618, 0x610848BE, 0x614848C5,
	0x61884620, 0x49BD48BE, 0x61C13040, 0x62014619, 0x624149B8,
	0x48C049BA, 0x62883140, 0x62C84620, 0x49B648B7, 0x63013040,
	0x461849B5, 0x63483140, 0x638848B0, 0x63C848B9, 0x462049B1,
	0x60083180, 0x604848AE, 0x60884618, 0x60C848AA, 0x610848B4,
	0x61484620, 0x618848A9, 0x61C84618, 0x620848A5, 0x624848B0,
	0x62884620, 0x62C848A4, 0x63084618, 0x634848A0, 0x638848AC,
	0x462148A1, 0x63C13080, 0x489E499F, 0x600831C0, 0x60484618,
	0x60884899, 0x60C848A6, 0x61084620, 0x61484898, 0x61884618,
	0x61C84894, 0x49A22003, 0x62C80400, 0x69C048A1, 0x43882102,
	0x61C8499F, 0x01C02061, 0x499F61C8, 0x6208489D, 0x6248489E,
	0x6288489E, 0x62C8489E, 0x6308489E, 0x6348489E, 0x6388489E,
	0x63C8489E, 0x489E4996, 0x60083140, 0x6048489D, 0x489D499E,
	0x48826048, 0x3028498F, 0x489C6148, 0x20556038, 0x0200499B,
	0x498B6108, 0x6108489A, 0x489A4998, 0x20FF6148, 0x30414994,
	0x60483140, 0x60304897, 0x60882080, 0x61084996, 0x4896498F,
	0x20FF6108, 0x30A14993, 0x63883140, 0x4893497D, 0x489462C8,
	0x60014992, 0x20004988, 0x60C839C0, 0x48856108, 0x30CF498F,
	0x60083180, 0x6048488E, 0x6088488E, 0x60C8488E, 0x68804882,
	0x03C92101, 0x49804308, 0x497D6088, 0x39C02001, 0x20FF6008,
	0x608830F9, 0x4A874978, 0x61111C89, 0x232960D1, 0x02DB4976,
	0x604B39C0, 0x4C834D84, 0x4984602C, 0x608A2200, 0x36404E82,
	0x22CF6032, 0x02124F71, 0x4A80613A, 0x2209617A, 0x02924F6E,
	0x613A3740, 0x4A6F4F7D, 0x4F73603A, 0x603A4A71, 0x4F714A66,
	0x378032CF, 0x4A70603A, 0x4A70607A, 0x4A7060BA, 0x4F6460FA,
	0x60BA4A75, 0x37404F62, 0x4F5F60BA, 0x3FC02201, 0x4A5C603A,
	0x1C924F6A, 0x60FA613A, 0x4A6F4F5A, 0x63FA3F40, 0x627A62FA,
	0x4A6C62BA, 0x637A321A, 0x4A6B4F5B, 0x62BA3F40, 0x4F534A5A,
	0x613A3A1E, 0x4F5122FF, 0x37403281, 0x2208607A, 0x22FF60BA,
	0x326D4F53, 0x2210603A, 0x4F4B613A, 0x60B83FC0, 0x602C607B,
	0x60882000, 0x485F6030, 0x61434B5D, 0x61834B5E, 0x61C34B5E,
	0x618B4B5E, 0x00892197, 0x21006201, 0x484A6241, 0x30802101,
	0x49316141, 0x6088202D, 0x3C404C4F, 0x014D6B20, 0x432843A8,
	0x6B206320, 0x43880089, 0x63204308, 0x49492021, 0x60480140,
	0x21036B20, 0x43880309, 0x6B206320, 0x43880151, 0x6B206320,
	0x43881049, 0x6B206320, 0x43882180, 0x63204308, 0x21606B20,
	0xE08B4388, 0x05D93B14, 0x05DA7627, 0x40022D40, 0x05DBB13B,
	0x05DCEC4F, 0x05DE2762, 0x05DF6276, 0x05E09D8A, 0x05E1D89E,
	0x05E313B1, 0x05E44EC5, 0x05E589D9, 0x05E6C4EC, 0x03600613,
	0x05E93B14, 0x6A0091D7, 0x40022E40, 0x05EA7627, 0x05EBB13B,
	0x05ECEC4F, 0x05EE2762, 0x05EF6276, 0x05F09D8A, 0x05F1D89E,
	0x05F313B1, 0x05F44EC5, 0x05F589D9, 0x05F6C4EC, 0x40041A80,
	0x40020000, 0x03020100, 0x40030000, 0x07060504, 0x0B0A0908,
	0x0F0E0D0C, 0x13121110, 0x17161514, 0x1B1A1918, 0x1F1E1D1C,
	0x23222120, 0x27262524, 0x00010001, 0x400250C0, 0x7F60010F,
	0x40020800, 0x0F141607, 0x0010108E, 0x08600140, 0x40025240,
	0x00020020, 0x0000E090, 0xC30041A0, 0x40041800, 0x00000A1E,
	0x1E1E0101, 0x00001111, 0x40024A00, 0x000A1FFF, 0x40020180,
	0x40024000, 0x0014148E, 0x40040080, 0x00000EEA, 0x00010208,
	0x0000022F, 0xCCDCF0FF, 0x40041900, 0x7289A1B8, 0x00005A59,
	0x00001D5A, 0x6B206320, 0x63204390, 0x08406B20, 0x63200040,
	0x6B6049FE, 0x04000C00, 0x63604308, 0x211F6B60, 0x43880409,
	0x43080351, 0x6B206360, 0x43B0010E, 0x63204330, 0xFD34F000,
	0xFD38F000, 0xFD3CF000, 0x43B06B20, 0x6B206320, 0x43881129,
	0x63204308, 0x43A86B20, 0x48EE6320, 0x47806800, 0x200049ED,
	0xB00B6088, 0xB5F8BDF0, 0x200849EB, 0x48EB61C8, 0x49EA6800,
	0x00400840, 0x48E96008, 0x227F6801, 0x43910612, 0x06922203,
	0x60014311, 0x22FF6801, 0x43910412, 0x04522221, 0x60014311,
	0x220F6801, 0x43910212, 0x02122207, 0x60014311, 0x21566802,
	0x02120A12, 0x6002430A, 0x200D49DA, 0x4EDA60C8, 0x270269F0,
	0x61F04338, 0x48D84CD9, 0x49D96020, 0x48D96061, 0x4BD960A0,
	0x4AD960E3, 0x4DD96122, 0x61A16165, 0x622361E0, 0x4DD76262,
	0x62E162A5, 0x63636320, 0x4DD563A2, 0x4CCD63E5, 0x60213440,
	0x60A36060, 0x4DCA60E2, 0x35404CD1, 0x6169612C, 0x61EB61A8,
	0x4CCF622A, 0x62A9626C, 0x632B62E8, 0x4CCD636A, 0x63E963AC,
	0x34804CC1, 0x60636020, 0x4DBF60A2, 0x35804CC9, 0x612960EC,
	0x61AB6168, 0x245D61EA, 0x622C0524, 0x62A86269, 0x632A62EB,
	0x636C4CC3, 0x63E863A9, 0x34C04CB5, 0x60626023, 0x4CC04DB3,
	0x60AC35C0, 0x612860E9, 0x61AA616B, 0x61EC4CBD, 0x62686229,
	0x62EA62AB, 0x632C4CBB, 0x63A86369, 0x4CBA63EB, 0x4DB96022,
	0x606C4CB9, 0x60E860A9, 0x616A612B, 0x61AC4CB7, 0x622861E9,
	0x62AA626B, 0x62EC4CB5, 0x63686329, 0x462C63AB, 0x4DAF63E2,
	0x35404CB2, 0x6069602C, 0x60EB60A8, 0x4CB0612A, 0x61A9616C,
	0x622B61E8, 0x4CAE626A, 0x62E962AC, 0x636B6328, 0x63A2462C,
	0x63EC4CAB, 0x34804CA3, 0x60606021, 0x60E260A3, 0x4CA84DA0,
	0x612C3580, 0x61A86169, 0x622A61EB, 0x0564242F, 0x62A9626C,
	0x632B62E8, 0x4CA2636A, 0x63E963AC, 0x34C04C97, 0x60636020,
	0x4D9F60A2, 0x612160E5, 0x61A36160, 0x4D9D61E2, 0x62616225,
	0x62E362A0, 0x4D9B6322, 0x63A16365, 0x4C9A63E0, 0x60626023,
	0x60A54D99, 0x612060E1, 0x61A26163, 0x61E54D97, 0x62606221,
	0x62E262A3, 0x63254D95, 0x63A06361, 0x4C9063E3, 0x60223440,
	0x60654D92, 0x60E060A1, 0x61626123, 0x61A24A90, 0x622061E1,
	0x49706263, 0x498E62A1, 0x496B62E1, 0x63606321, 0x496C63A3,
	0x4A8463E1, 0x3280498A, 0x49666011, 0x60906051, 0x496760D3,
	0x49876111, 0x49626151, 0x61D06191, 0x49636213, 0x215F6251,
	0x62910509, 0x62D1495D, 0x63536310, 0x6391495E, 0x63D1497F,
	0x49594A75, 0x601132C0, 0x60936050, 0x60D14959, 0x6111497B,
	0x61514954, 0x61D36190, 0x62114955, 0x62514978, 0x62914950,
	0x631362D0, 0x63514951, 0x63914975, 0x63D1494C, 0x60084974,
	0x4A73604B, 0x6091494C, 0x60D14972, 0x61114947, 0x61936150,
	0x61D04848, 0x486F4A70, 0x48706010, 0x48706050, 0x60D36090,
	0x6111496F, 0x04E424B9, 0x4C6B6154, 0x61D06194, 0x62516213,
	0x62944C6B, 0x62D44C67, 0x63536310, 0x4C696391, 0x4A6363D4,
	0x32404C63, 0x60506014, 0x60D16093, 0x61144C65, 0x61544C5F,
	0x61D36190, 0x4C636211, 0x4C5C6254, 0x62D06294, 0x63516313,
	0x63944C60, 0x63D44C58, 0x32804A56, 0x60536010, 0x4C5D6091,
	0x4C5460D4, 0x61506114, 0x61D16193, 0x62144C5A, 0x62544C50,
	0x62D36290, 0x4C586311, 0x4C4D6354, 0x63D06394, 0x32C04A4A,
	0x60516013, 0x60944C54, 0x60D44C48, 0x61536110, 0x4C526191,
	0x4C4561D4, 0x62506214, 0x62D16293, 0x63144C4F, 0x63544C41,
	0x63D36390, 0x60114A4D, 0x60544C4D, 0x60944C3D, 0x611360D0,
	0x24BB6151, 0x619404E4, 0x61D44C39, 0x62536210, 0xE08D6291,
	0x00000AF2, 0x100008F8, 0x4000F000, 0x40024000, 0x40041800,
	0x40040080, 0x40020840, 0x40020000, 0x05C62762, 0x40022800,
	0x0F141A07, 0x6A0291FF, 0x0000C890, 0x0F60020F, 0x05C76276,
	0x05C89D8A, 0x05C9D89E, 0x05CB13B1, 0x05CC4EC5, 0x05CD89D9,
	0x05CEC4EC, 0x05D13B14, 0x05D27627, 0x05D3B13B, 0x05D4EC4F,
	0x40022900, 0x05D62762, 0x05D76276, 0x05D89D8A, 0x05D9D89E,
	0x05DB13B1, 0x05DC4EC5, 0x05DD89D9, 0x05DEC4EC, 0x05E13B14,
	0x05E27627, 0x05E3B13B, 0x05E4EC4F, 0x40022A00, 0x05E62762,
	0x05E76276, 0x05E89D8A, 0x05E9D89E, 0x05EB13B1, 0x05EC4EC5,
	0x05ED89D9, 0x05EEC4EC, 0x05F13B14, 0x05F27627, 0x05F3B13B,
	0x05F4EC4F, 0x40022B00, 0x05F62762, 0x05C6C4EC, 0x40022C00,
	0x0F141604, 0x6A0091D7, 0x0360060D, 0x05C93B14, 0x05CA7627,
	0x05CBB13B, 0x05CCEC4F, 0x05CE2762, 0x05CF6276, 0x05D09D8A,
	0x05D1D89E, 0x05D313B1, 0x05D44EC5, 0x05D589D9, 0x40022D00,
	0x05D6C4EC, 0x62D44CFE, 0x63144CFE, 0x63936350, 0x4AFE63D1,
	0x60144CFC, 0x60544CFA, 0x60D36090, 0x4CFB6111, 0x4CF76154,
	0x61D06194, 0x62516213, 0x62944CF8, 0x62D44CF3, 0x63536310,
	0x4CF66391, 0x4AF263D4, 0x32404CEF, 0x60506014, 0x60D16093,
	0x61144CF2, 0x61544CEB, 0x61D36190, 0x4CF06211, 0x4CE86254,
	0x62D06294, 0x63516313, 0x63944CED, 0x63D44CE4, 0x32804AE5,
	0x60536010, 0x4CEA6091, 0x4CE060D4, 0x61506114, 0x61D16193,
	0x621149E7, 0x62906254, 0x46114618, 0x48E562C8, 0x48E56308,
	0x46206348, 0x48E46388, 0x49D863C8, 0x31C04618, 0x48DF6008,
	0x48E16048, 0x46206088, 0x48DE60C8, 0x46186108, 0x48DA6148,
	0x20BD6188, 0x61C804C0, 0x62084620, 0x624848D8, 0x62884618,
	0x62C848D4, 0x630848D7, 0x63484620, 0x638848D3, 0x63C84618,
	0x48CF49D4, 0x48D46008, 0x46206048, 0x48CE6088, 0x461860C8,
	0x48CA6108, 0x48D06148, 0x46206188, 0x48C961C8, 0x46186208,
	0x48C56248, 0x48CC6288, 0x462062C8, 0x48C46308, 0x46186348,
	0x48C06388, 0x49C463C8, 0x314048C7, 0x46206008, 0x48BE6048,
	0x46186088, 0x48BA60C8, 0x48C36108, 0x46206148, 0x48B96188,
	0x461861C8, 0x48B56208, 0x48BF6248, 0x46206288, 0x48B462C8,
	0x46186308, 0x48B06348, 0x48BB6388, 0x49B363C8, 0x31804620,
	0x48AE6008, 0x46186048, 0x48AA6088, 0x48B660C8, 0x46206108,
	0x48A96148, 0x46186188, 0x48A561C8, 0x48B26208, 0x46206248,
	0x48A46288, 0x461862C8, 0x48A06308, 0x48AE6348, 0x46206388,
	0x49A263C8, 0x31C0489E, 0x46186008, 0x489A6048, 0x48A96088,
	0x462060C8, 0x48996108, 0x46186148, 0x48956188, 0x200361C8,
	0x040049A4, 0x69F062C8, 0x43B84631, 0x206161C8, 0x61C801C0,
	0x48A049A1, 0x488F6048, 0x30284631, 0x49A06148, 0x6008489E,
	0x499F2055, 0x61080200, 0x46311CE0, 0x499C6108, 0x6148489C,
	0x499720FF, 0x31403041, 0x499B6048, 0x60084899, 0x20804993,
	0x60883140, 0x48984601, 0x4A906101, 0x61114997, 0x4A9521FF,
	0x324031A1, 0x4A8A6391, 0x62D14994, 0x49944A95, 0x4A896011,
	0x3AC02100, 0x611160D1, 0x4A914985, 0x328031CF, 0x49906011,
	0x49906051, 0x49906091, 0x498460D1, 0x03BA6889, 0x4A824311,
	0x4A7E6091, 0x3AC02101, 0x23FF6011, 0x609333F9, 0x4A894979,
	0x61111C89, 0x242960D1, 0x02E44977, 0x604C39C0, 0x4D854E86,
	0x49866035, 0x608A2200, 0x4A844617, 0x60173240, 0x4F7322CF,
	0x613A0212, 0x617A4A81, 0x4F702209, 0x37400292, 0x4F71613A,
	0x603A4A6F, 0x4A734F74, 0x4A67603A, 0x32CF4F72, 0x603A3780,
	0x607A4A71, 0x60BA4A71, 0x60FA4A71, 0x4A764F65, 0x4F6460BA,
	0x60BA3740, 0x22014F5F, 0x603A3FC0, 0x4F6C4A5C, 0x613A1C92,
	0x4F5B60FA, 0x3F404A6F, 0x62FA63FA, 0x62BA627A, 0x321A4A6C,
	0x4F5D637A, 0x3F404A6B, 0x4A5C62BA, 0x3A1E4F53, 0x22FF613A,
	0x32814F51, 0x607A3740, 0x60BA2208, 0x326D22FF, 0x22106002,
	0x484C6102, 0x608338C0, 0x60356044, 0x60882000, 0x485A4603,
	0x60033040, 0x4B5D485E, 0x4B5E6143, 0x4B5E6183, 0x4B5E61C3,
	0x2197618B, 0x62010089, 0x62412100, 0x2001494A, 0x61483180,
	0x202D4959, 0x48426088, 0x6B013840, 0x43990403, 0x63014319,
	0x03D36B01, 0x43194399, 0x21216301, 0x01494B3B, 0x6B016059,
	0x031B2303, 0x63014399, 0x15436B01, 0x63014399, 0x15836B01,
	0x63014399, 0x23806B01, 0x43194399, 0x6B016301, 0x43992360,
	0x6B016301, 0x63014391, 0x08496B01, 0x63010049, 0x6B414A31,
	0x0C0932D4, 0x43110409, 0x6B416341, 0x0412221F, 0x22014391,
	0xE0770452, 0x05D93B14, 0x0F141604, 0x05DA7627, 0x40022D40,
	0x05DBB13B, 0x05DCEC4F, 0x05DE2762, 0x05DF6276, 0x05E09D8A,
	0x05E1D89E, 0x05E313B1, 0x05E44EC5, 0x0360060D, 0x05E589D9,
	0x6A0091D7, 0x05E6C4EC, 0x05E93B14, 0x40022E40, 0x05EA7627,
	0x05EBB13B, 0x05ECEC4F, 0x05EE2762, 0x05EF6276, 0x05F09D8A,
	0x05F1D89E, 0x05F313B1, 0x05F44EC5, 0x05F589D9, 0x05F6C4EC,
	0x40041A80, 0x00010001, 0x400250C0, 0x7F60010F, 0x4000F400,
	0x40020800, 0x0010108E, 0x08600140, 0x40040080, 0x40025240,
	0x00020020, 0x0000E090, 0xC30041A0, 0x40041800, 0x00000A1E,
	0x1E1E0101, 0x00001111, 0x40024A00, 0x000A1FFF, 0x40020180,
	0x40024000, 0x0014148E, 0x00000EEA, 0x00010208, 0x0000022F,
	0xCCDCF0FF, 0x40041900, 0x7289A1B8, 0x00005A59, 0x00001D5A,
	0x40020000, 0x63414311, 0x03C26B01, 0x43114391, 0xF0006301,
	0x4802F83D, 0x47806800, 0x0000BDF8, 0x100008F8, 0x4801B403,
	0xBD019001, 0x000140E9, 0x4801B403, 0xBD019001, 0x000003A1,
	0x4801B403, 0xBD019001, 0x000145ED, 0x4801B403, 0xBD019001,
	0x00014487, 0x4801B403, 0xBD019001, 0x00017D1D, 0x4801B403,
	0xBD019001, 0x000145F9, 0x4801B403, 0xBD019001, 0x000145FF,
	0x4801B403, 0xBD019001, 0x0001427F, 0x4801B403, 0xBD019001,
	0x0000053F, 0x4801B403, 0xBD019001, 0x00016629, 0x4801B403,
	0xBD019001, 0x000164BD, 0x4801B403, 0xBD019001, 0x00016E95,
0x00000000};

at_ble_status_t at_ble_init(void* args)
{
	at_ble_status_t  status;

	status = platform_init(args);
	
	at_fw_patch_download(fw_patch, sizeof(fw_patch));

	if(status == AT_BLE_SUCCESS)
	{
		
		event_init();
		if(gapm_reset_req_handler() != ATT_ERR_NO_ERROR)
		{
			status = AT_BLE_FAILURE;
		}
	}

	// init device info
	if(status == AT_BLE_SUCCESS)
	{
		device.srLen = 0;
		device.advLen = 0;
		device.role = ROLE_SLAVE;
		device.at_addr_set = false;
		at_ble_device_name_set((uint8_t *)GAP_device_name,sizeof(GAP_device_name));
		
	}
	return status;
}
at_ble_status_t at_ble_device_name_set(uint8_t* dev_name, uint8_t len)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	do
	{
		if(dev_name == NULL)
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}
		
		if(gapm_set_dev_name_handler (len,dev_name) != ATT_ERR_NO_ERROR)
		{
			status = AT_BLE_FAILURE;
		}
	}while(0);

	return status;
}

void at_fw_patch_download(uint32_t* patch, uint32_t patch_size)
{
	uint32_t i=0;
	uint32_t fp_val;
	for (i=0; i<patch_size; i++)
	{
		uint8_t j=10;
		dbg_wr_mem_req_handler32(0x10008000+i*4, &patch[i], 4);
	/*	while(j!=0)
			j--;*/
	}
	
	fp_val = 0x100081ad;
	dbg_wr_mem_req_handler32(0x10000004, &fp_val, 4);
//	fp_val = 0x1000814d;
//	dbg_wr_mem_req_handler32(0x100000e0, &fp_val, 4);
	fp_val = 0x100081d7;
	dbg_wr_mem_req_handler32(0x10000928, &fp_val, 4);
//	fp_val = 0x10009c73;
//	dbg_wr_mem_req_handler32(0x1000092c, &fp_val, 4);
	fp_val = 0x5fa0004;
	dbg_wr_mem_req_handler32_reset(0xe000ed0c, &fp_val, 4);
	
	for(i=0; i<10000; i++)
		fp_val++;
}

// To do support random address
at_ble_status_t at_ble_addr_set(at_ble_addr_t* address)
{
	uint8_t u8Status;
	at_ble_status_t status = AT_BLE_SUCCESS;

	do
	{
		if((address->addr == NULL) || 
			(address->type >AT_BLE_ADDRESS_RANDOM_PRIVATE_NON_RESOLVABLE))
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}
		if(address->type == AT_BLE_ADDRESS_PUBLIC)
		{
			u8Status = dbg_le_set_bd_addr_req_handler(address->addr);

			if(u8Status!=AT_BLE_SUCCESS)
			{
				status = AT_BLE_FAILURE;
				break;
			}
			device.at_addr_set = true;
			device.at_dev_addr.type = address->type;
			memcpy(device.at_dev_addr.addr, address->addr ,AT_BLE_ADDR_LEN);
		}
	}while(0);
	return status;
}

at_ble_status_t at_ble_addr_get(at_ble_addr_t* address)
{
	#define AT_BT_DEFAULT_BDADDR "\x01\x23\x45\x67\x89\xAB"

	if(device.at_addr_set == true)
	{
		address->type = device.at_dev_addr.type;
		memcpy(address->addr, device.at_dev_addr.addr,AT_BLE_ADDR_LEN);
	}
	else
	{
		// To do check device default address
		address->type = AT_BLE_ADDRESS_PUBLIC;
		memcpy(address->addr,(uint8_t *)AT_BT_DEFAULT_BDADDR,AT_BLE_ADDR_LEN);
	}
	
	return AT_BLE_SUCCESS;
}

at_ble_status_t at_ble_adv_data_set( uint8_t const *const adv_data,
	uint8_t adv_data_len,uint8_t const *const scan_resp_data,
	uint8_t scan_response_data_len)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	
	do
	{
		if((adv_data== NULL) && (scan_resp_data == NULL))
		{
			status = AT_BLE_FAILURE;  
			break;
		}
		if((adv_data_len > AT_BLE_ADV_MAX_SIZE) || 
			(scan_response_data_len > AT_BLE_ADV_MAX_SIZE))
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}

	    if((adv_data != NULL) && (adv_data_len == 0) )
	    {
	       	// Clear advertising data
			memset(device.ADVData,0, AT_BLE_ADV_MAX_SIZE);
			device.advLen =  0;
	    }
		else if((adv_data != NULL) && (adv_data_len > 0))
		{
			// To do add advertising data check
			memcpy(device.ADVData,adv_data, adv_data_len);
			device.advLen =  adv_data_len;
		}

		if(scan_resp_data != NULL && scan_response_data_len == 0 )
	    {
	       	// Clear scan response data
			memset(device.SrData,0, AT_BLE_ADV_MAX_SIZE);
			device.srLen = 0;
	    }
		else if((scan_resp_data != NULL) && (scan_response_data_len > 0))
		{
			// To do add scan response data check
		    memcpy(device.SrData, scan_resp_data,scan_response_data_len);
			device.srLen = scan_response_data_len;
		}
	}while(0);
	return status;
}

at_ble_status_t at_ble_adv_start(at_ble_adv_type_t type,at_ble_adv_mode_t mode,
				at_ble_addr_t* peer_addr,at_ble_filter_type_t filtered, 
				uint16_t interval, uint16_t timeout, bool disable_randomness)
{
	uint8_t u8Status,adv_type;
	at_ble_addr_t local_addr;
	uint8_t scan_rsp_len = device.srLen;

	at_ble_status_t status = AT_BLE_SUCCESS;

	// To do add timeout value for GAP
	do
	{
		//If the advertising event type is either a discoverable undirected
		//event type or a non-connectable undirected event type, the advInterval shall
		//not be less than 100 ms. If the advertising event type is a connectable undirected
		//event type, the advInterval can be 20 ms or greater.
		if(((type == AT_BLE_ADV_TYPE_DIRECTED)&&(timeout != 0))
		||(type > AT_BLE_ADV_TYPE_NONCONN_UNDIRECTED)
		||(interval > AT_BLE_ADV_INTERVAL_MAX)
		||((type == AT_BLE_ADV_TYPE_UNDIRECTED)&&(interval < AT_BLE_ADV_INTERVAL_MIN)) 
		||((interval < AT_BLE_ADV_NONCON_INTERVAL_MIN) && 
		((type >= AT_BLE_ADV_TYPE_SCANNABLE_UNDIRECTED)))
		||((type == AT_BLE_ADV_TYPE_DIRECTED)&&(peer_addr == NULL)) )
		{
			 status = AT_BLE_INVALID_PARAM;
			 break;
		};

		status = at_ble_addr_get(&local_addr);
		if(status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}
		// To do check privacy setting and IRK key
		u8Status = gapm_set_dev_config_cmd_handler(GAP_PERIPHERAL_SLV, IRK_KEY, 
				0, GAPM_WRITE_DISABLE, GAPM_WRITE_DISABLE, APP_MAX_MTU,
				APP_CON_INTV_MIN, APP_CON_INTV_MAX, APP_CON_LATENCY, 
				APP_SUPERV_TO, APP_FLAGS);
	
		if(u8Status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}
		switch(type)
		{
			default:
			case  AT_BLE_ADV_TYPE_UNDIRECTED :
				adv_type = GAPM_ADV_UNDIRECT;
				break;
			case  AT_BLE_ADV_TYPE_DIRECTED:     
				adv_type = GAPM_ADV_DIRECT;
				break;
			/* differentiate between them by using scan response length*/
			case AT_BLE_ADV_TYPE_NONCONN_UNDIRECTED:
				scan_rsp_len = 0;
			case AT_BLE_ADV_TYPE_SCANNABLE_UNDIRECTED:     
				adv_type = GAPM_ADV_NON_CONN;
				break;
		}

		gapm_start_adv_cmd_handler(adv_type, local_addr.type,
			GAP_TMR_PRIV_ADDR_INT, (peer_addr==NULL ? NULL : peer_addr->addr),
			interval, interval, 7, mode, filtered,
			device.advLen, device.ADVData, scan_rsp_len, device.SrData);
		
	}while(0);
	return status;
}

at_ble_status_t at_ble_adv_stop(void)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	
	if(gapm_cancel_cmd_handler())
	{
		status = AT_BLE_FAILURE; 
	}
	return status;
}

at_ble_status_t at_ble_adv_set_tx_power(int8_t power)
{
	// To do check ble max connection number
	at_ble_status_t status = at_ble_tx_power_set(8,power);
	return status;
}
at_ble_status_t at_ble_scan_start(uint16_t interval,uint16_t window,uint16_t timeout,
	at_ble_scan_type_t type ,at_ble_scan_mode_t mode, bool filter_whitelist, 
	bool filter_dublicates)
{
	uint8_t scan_type,u8Status;
	at_ble_addr_t local_addr;
	at_ble_status_t status = AT_BLE_SUCCESS;

	// To do support scan timeout
	do
	{
	    // if the scanning window is smaller or equal to the scanning interval
		if ((mode > AT_BLE_SCAN_OBSERVER_MODE)
		||(window > interval)
		||(type > AT_BLE_SCAN_ACTIVE)
		||(window > AT_BLE_SCAN_WINDOW_MAX)
		||(window < AT_BLE_SCAN_WINDOW_MIN)
		||(interval > AT_BLE_SCAN_INTERVAL_MAX)
		||(interval < AT_BLE_SCAN_INTERVAL_MIN))
		{
			 status = AT_BLE_INVALID_PARAM;
			 break;
		};
		
		status = at_ble_addr_get(&local_addr);
		if(status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}
		u8Status = gapm_set_dev_config_cmd_handler(GAP_CENTRAL_MST, IRK_KEY,768,
			GAPM_WRITE_DISABLE, GAPM_WRITE_DISABLE, APP_MAX_MTU, 0, 0, 0, 0, 0);

		if(u8Status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}
		
		if(type == AT_BLE_SCAN_PASSIVE)
		{
			scan_type = GAPM_SCAN_PASSIVE; 
		}
		else
		{
			scan_type = GAPM_SCAN_ACTIVE;
		}

		gapm_start_scan_cmd_handler(scan_type, local_addr.type, 
			GAP_TMR_PRIV_ADDR_INT,
			local_addr.addr, interval, window, mode, 
			filter_whitelist, filter_dublicates);

	}while(0);
	return status;
}

at_ble_status_t at_ble_scan_stop(void)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	
	if(gapm_cancel_cmd_handler())
	{
		status = AT_BLE_FAILURE; 
	}
	return status;
}

at_ble_status_t at_ble_connect(at_ble_addr_t peers[], uint8_t peer_count, 
	uint16_t scan_interval, uint16_t scan_window, at_ble_connection_params_t* connection_params)
{

	at_ble_status_t status = AT_BLE_SUCCESS;
	do
	{
		/* check for the range validity of the values */
		if ( (connection_params->con_intv_max < AT_CNX_INTERVAL_MIN || 
		connection_params->con_intv_max > AT_CNX_INTERVAL_MAX) ||
		(connection_params->con_intv_min < AT_CNX_INTERVAL_MIN ||
		connection_params->con_intv_min > AT_CNX_INTERVAL_MAX) ||
		(connection_params->superv_to  < AT_CNX_SUP_TO_MIN   || 
		connection_params->superv_to  > AT_CNX_SUP_TO_MAX)   ||
		(connection_params->con_latency  > AT_CNX_LATENCY_MAX) )
		{
			status = AT_BLE_INVALID_PARAM;
			break;
		}

		device.role = ROLE_MASTER;

		status = gapm_set_dev_config_cmd_handler(GAP_CENTRAL_MST, IRK_KEY,768,
		GAPM_WRITE_DISABLE, GAPM_WRITE_DISABLE, APP_MAX_MTU, 0, 0, 0, 0, 0);

		/*if(status!=AT_BLE_SUCCESS)
		{
			status = AT_BLE_FAILURE;
			break;
		}*/

		gapm_start_connection_cmd_handler(GAPM_CONNECTION_AUTO, LOCAL_ADDR_TYPE, 
			GAP_TMR_PRIV_ADDR_INT, rand_addr, scan_interval, scan_window,
			connection_params->con_intv_min, connection_params->con_intv_max,
			connection_params->con_latency,
			connection_params->superv_to,
			connection_params->ce_len_min,
			connection_params->ce_len_max,
			peer_count, peers);

	}while(0);
	return status;
}

at_ble_status_t at_ble_connect_cancel(void)
{
	at_ble_status_t status = AT_BLE_SUCCESS;
	
	if(gapm_cancel_cmd_handler())
	{
		status = AT_BLE_FAILURE; 
	}
	return status;
}

at_ble_status_t at_ble_whitelist_add(at_ble_addr_t* address)
{
	if(address->addr == NULL)
	{
		return AT_BLE_FAILURE;
	}

	gapm_white_list_mgm_cmd(GAPM_ADD_DEV_IN_WLIST, 
		address->type, address->addr);

	return AT_BLE_SUCCESS;
}

at_ble_status_t at_ble_whitelist_remove(at_ble_addr_t* address)
{
	if(address->addr == NULL)
	{
		return AT_BLE_FAILURE;
	}

	gapm_white_list_mgm_cmd(GAPM_RMV_DEV_FRM_WLIST, 
		address->type, address->addr);

	return AT_BLE_SUCCESS;
}

at_ble_status_t at_ble_whitelist_clear(void)
{
	gapm_white_list_mgm_cmd(GAPM_CLEAR_WLIST, 
		0, NULL);

	return AT_BLE_SUCCESS;
}

at_ble_status_t at_ble_disconnect(at_ble_handle_t handle, at_ble_disconnect_reason_t reason)
{
	uint8_t gapc_reason ;
	switch(reason)
	{
		case AT_BLE_TERMINATED_BY_USER:
			gapc_reason = 0x13;
			break;
		case AT_BLE_UNACCEPTABLE_INTERVAL:
			gapc_reason = 0x3b;
			break;
		default:
			gapc_reason = 0x1F;
	}
	gapc_disconnect_cmd_handler(gapc_reason, handle);
	
	return AT_BLE_SUCCESS;
}


at_ble_status_t at_ble_connection_param_update(at_ble_handle_t handle, 
	at_ble_connection_params_t* connection_params)
{
	/* check for the range validity of the values */
	if ( (connection_params->con_intv_max < AT_CNX_INTERVAL_MIN || 
	connection_params->con_intv_max > AT_CNX_INTERVAL_MAX) ||
	(connection_params->con_intv_min < AT_CNX_INTERVAL_MIN ||
	connection_params->con_intv_min > AT_CNX_INTERVAL_MAX) ||
	(connection_params->superv_to  < AT_CNX_SUP_TO_MIN   || 
	connection_params->superv_to  > AT_CNX_SUP_TO_MAX)   ||
	(connection_params->con_latency  > AT_CNX_LATENCY_MAX) )
	{
		return AT_BLE_INVALID_PARAM;
	}

	gapc_param_update_cmd_handler(handle,
		connection_params->con_intv_min, connection_params->con_intv_max,
		connection_params->con_latency, connection_params->superv_to, 
		connection_params->ce_len_min, connection_params->ce_len_max);

	return AT_BLE_SUCCESS;
}

// To do check parameters
void at_ble_conn_update_reply(at_ble_handle_t conn_handle , 
				at_ble_connection_params_t* connection_params)
{
	gapc_param_update_cfm_handler(conn_handle, 
		connection_params->ce_len_min, connection_params->ce_len_max);
}

at_ble_status_t at_ble_tx_power_set(at_ble_handle_t conn_handle, int8_t power)
{
	uint8_t level;
	/// Power table
	static const int8_t RF_RPL_TX_PW_CONV_TBL[RPL_PWR_TBL_SIZE] 
			= {-23,-20,-17,-14,-11,-8,-5,-2};


	for(level = RPL_POWER_MIN; level <= RPL_POWER_MAX; level++)
	{
		if(RF_RPL_TX_PW_CONV_TBL[level] >= power)
			break;
	}

	if(level > RPL_POWER_MAX)
	{
		level = RPL_POWER_MAX;
	}

	if(dbg_set_tx_pw_req_handler(conn_handle, level) != AT_BLE_SUCCESS)
	{
		return AT_BLE_FAILURE;
	}
	else
	{
		return AT_BLE_SUCCESS;
	}
}


